!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function e(){return D++}function i(t){for(var e=0,i=t.length,s=0;s<i;++s){var r=t.charCodeAt(s);e=(e<<5)-e+r,e|=0}return e}function s(t){return t>=0?t+1:t<0?t+1:t+1}function r(t,e){var i=1/e;return Math.round(t*i)/i}function h(t){this.sindex<this.stack.length-1&&this.dequeue(this.sindex,this.stack.length-1),this.stack.splice(this.sindex+1,this.stack.length),this.stack.push(t),this.redo(),this.undo(),this.redo()}function n(t,e){var i=this;t+=1;var s=e-(t-1);console.log("Dequeue stack by",s,"operations");for(var r=this.batches.tiles,h=0;h<s;++h){for(var n=t+h,a=i.stack[n],o=r.splice(a.index,1),c=0;c<o.length;++c)for(var l=o[c],f=0;f<l.length;++f){var u=l[f];if(u.overwrite.length){var d=u.overwrite.splice(0,1)[0];u.colors.shift(),u.cindex=d.cindex-1}}for(var v=0;v<this.stack.length;++v)i.stack[v].index-=1}}function a(t,e){t.batch.map(function(t){var i=t.cindex,s=t.colors.length-1;e===!0?t.cindex-=i>0?1:0:t.cindex+=i<s?1:0})}function o(){return this.stack[this.sindex]}function c(){if(this.sindex>=0){var t=this.currentStackOperation();this.fire(t,!1),this.sindex--}}function l(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,!0)}}function f(t,e){this.modes.draw&&this.pushTileBatch(t,e,!1)}function u(t,e,i){var s=this.createTileAt(t*G|0,e*G|0);return s.colors.unshift(i),this.batches.tiles.push([s]),this.finalizeBatchOperation(),s}function d(t,e,i){this.modes.drag=i,this.modes.draw=!!i,i&&this.modes.draw?(this.colorTest=this.getRandomRgbaColors(),this.pushTileBatchOperation(),this.pushTileBatch(t,e,!1),this.clearLatestTileBatch()):this.finalizeBatchOperation()}function v(){this.modes.selectAll=!0}function g(t,e){this.mx=t,this.my=e,this.unHoverAllTiles();var i=this.getTileByMouseOffset(t,e);null!==i&&(this.hovered.push(i),i.isHovered=!0)}function p(){for(var t=this,e=0;e<this.hovered.length;++e)t.hovered[e].isHovered=!1,t.hovered.splice(e,1)}function m(){var t=this.batches.tiles.length-1,e=this.batches.tiles[t];this.createBufferFromBatch(e);this.enqueue({batch:e,index:t})}function x(){var t=this.getLatestTileBatchOperation();if(t.length<=0){var e=this.batches.tiles.length-1;this.batches.tiles.splice(e,1)}}function y(){var t=this.batches.tiles.length-1,e=this.batches.tiles;return e[t]}function w(){var t=[];this.batches.tiles.push(t)}function T(t,e,i){var s=i?this.getTileByPosition(t,e):this.getTileByMouseOffset(t,e),r=[this.colorTest[0],this.colorTest[1],this.colorTest[2],this.colorTest[3]],h=this.getLatestTileBatchOperation();if(null!==s){var n=s.colors[s.cindex],a=this.colorArraysMatch(r,n);a||2===n[3]||(s.colors.unshift(r),s.overwrite.unshift({cindex:s.cindex+1,tile:s}),h.push(s))}else{var o=i?this.createTileAt(t,e):this.createTileAtMouseOffset(t,e);o.colors.unshift(r),h.push(o)}}function b(){var t=256,e=Math.random()*t|0,i=Math.random()*t|0,s=Math.random()*t|0;return[e,i,s,1]}function B(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function O(t){for(var e=(Y.MAX_W,Y.MAX_H,[]),i=[],s=0;s<t.length;++s){var r=t[s];e.push(r.x),i.push(r.y)}e.sort(function(t,e){return t-e}),i.sort(function(t,e){return t-e});var h=e.length-1,n=e[0]/G|0,a=i[0]/G|0,o=((e[h]-e[0])/G|0)+1,c=((i[h]-i[0])/G|0)+1;return{x:n,y:a,w:o,h:c}}function A(t){for(var e=this.getBatchSize(t),i=({x:e.x,y:e.y,width:e.w,height:e.h,buffer:null},this.instance.createCanvasBuffer(e.w,e.h)),s=e.w,r=0;r<t.length;++r){var h=t[r],n=h.colors[h.cindex],a=n[0],o=n[1],c=n[2],l=n[3],f=r%s,u=Math.floor(r/s);i.fillStyle="rgba("+a+","+o+","+c+","+l+")",i.fillRect(f,u,1,1)}this.instance.rofl=i.canvas}function S(t){var e=this.getBatchSize(t);return e.w>=Y.MIN_W&&e.h>=Y.MIN_W}function k(t,e){var i=this.camera.getRelativeOffset(t,e),s=this.getTileOffsetAt(i.x,i.y);return s}function M(t,e){var i=G/2,s=r(t-i,G),h=r(e-i,G);return{x:s,y:h}}function R(t,e){var i=this.getRelativeOffset(t,e),s=this.createTileAt(i.x,i.y);return s}function z(t,e){var i=new et;return i.x=t,i.y=e,i}function E(t,e){var i=this.getRelativeOffset(t,e),s=this.getTileByPosition(i.x,i.y);return s}function I(t,e){for(var i=null,s=this.batches.tiles,r=0;r<s.length;++r)for(var h=s[r],n=0;n<h.length;++n){var a=h[n];a.x===t&&a.y===e&&(i=a)}return i}function L(t){for(var e=this.batches.tiles,i=0;i<e.length;++i)for(var s=e[i],r=0;r<s.length;++r)if(s[r].id===t)return tile;return null}function C(t){var e=this.camera.s,i=this.camera.width,s=this.camera.height,r=G*e,h=G*e,n=t.x*e+this.camera.x,a=t.y*e+this.camera.y;return n+r>=0&&n<=i&&a+h>=0&&a<=s}function P(t,e,i){var s=this,r=t.canvas,h=r.width,n=r.height,a=t.getImageData(0,0,h,n).data,o=this.getRelativeOffset(e,i),c=o.x,l=o.y;this.pushTileBatchOperation();for(var f=this.getLatestTileBatchOperation(),u=0;u<n;++u)for(var d=0;d<h;++d){var v=4*(d+u*h),g=a[v+3];if(!(g<=0)){var p=a[v+0],m=a[v+1],x=a[v+2],y=s.createTileAt(c+d*G,l+u*G);g=Math.round(g*U*10)/10,y.colors.unshift([p,m,x,g]),f.push(y)}}this.clearLatestTileBatch(),f.length&&this.finalizeBatchOperation()}function H(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,this.camera.resize(t,e),this.generateBackground(),this.clear(),this.render()}function _(){this.ctx.clearRect(0,0,this.width,this.height)}function F(){this.renderBackground(),this.renderTiles(),this.rofl&&this.ctx.drawImage(this.rofl,0,0),this.camera.s>J&&this.renderGrid(),this.renderStats()}function q(){var t=this.camera.width,e=this.camera.height;this.ctx.drawImage(this.bg,0,0,t,e,0,0,t,e)}function W(){var t=this.ctx,e=G*this.camera.s|0,i=this.camera.x,s=this.camera.y,r=this.camera.width,h=this.camera.height;t.lineWidth=.25,t.strokeStyle="rgba(51,51,51,0.75)",t.beginPath();for(var n=i%e|0;n<r;n+=e)t.moveTo(n,0),t.lineTo(n,h);for(var a=s%e|0;a<h;a+=e)t.moveTo(0,a),t.lineTo(r,a);t.stroke(),t.closePath()}function V(){for(var t=this,e=this.ctx,i=this.camera.x,s=this.camera.y,r=this.camera.s,h=G*r|0,n=G*r|0,a=this.editor.modes.selectAll,o=this.editor.batches.tiles,c=0;c<o.length;++c)for(var l=o[c],f=0;f<l.length;++f){var u=l[f],d=i+u.x*r|0,v=s+u.y*r|0,g=u.colors[u.cindex],p=g[0],m=g[1],x=g[2],y=g[3];a?y=.1:u.isHovered&&(y/=1.5),t.editor.isTileInsideView(u)&&(e.fillStyle="rgba("+p+","+m+","+x+","+y+")",e.fillRect(d,v,h,n))}}function j(){this.ctx.fillStyle="#ffffff";var t=this.editor.mx,e=this.editor.my,i=this.editor.getRelativeOffset(t,e),s=i.x,r=i.y,h=this.editor.getTileByPosition(s,r);if(this.ctx.fillText("x:"+s+", y:"+r,16,32),null!==h){var n=h.colors[h.cindex],a=n[0],o=n[1],c=n[2],l=n[3];this.ctx.fillText(a+","+o+","+c+","+l,16,48)}this.renderFPS()}function N(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillText(1e3/e|0,16,16)}function X(){var t=8,e=this.camera.width,i=this.camera.height,s=(this.createCanvasBuffer(e,i),document.createElement("canvas")),r=s.getContext("2d");s.width=e,s.height=i,this.bg=s,r.fillStyle="#1f1f1f",r.fillRect(0,0,e,i),r.fillStyle="#212121";for(var h=0;h<i;h+=2*t)for(var n=0;n<e;n+=2*t)r.fillRect(n,h,t,t),r.fillRect(n,h,t,t);for(var a=t;a<i;a+=2*t)for(var o=t;o<e;o+=2*t)r.fillRect(o,a,t,t)}var D=0,G=8,J=.5,K=35,Q=[0,0,0,0],U=.00392,Y={MIN_W:128,MIN_H:128,MAX_W:1048,MAX_H:1048},Z=i("draw"),$=function(t){this.x=0,this.y=0,this.s=J+6,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};$.prototype.scale=function(t){t=42*t/(Math.hypot(this.width,this.height)/2)*s(this.s);var e=this.s;this.s+t<=J?this.s=J:this.s+t>=K?this.s=K:this.s+=t,this.s=r(this.s,.125),this.x-=this.lx*(s(this.s)-s(e)),this.y-=this.ly*(s(this.s)-s(e))},$.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},$.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.clear(),this.instance.render()},$.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,s=(e-this.y)/this.s;return{x:i,y:s}},$.prototype.resize=function(t,e){this.width=t,this.height=e};var tt=Object.freeze({enqueue:h,dequeue:n,fire:a,currentStackOperation:o,undo:c,redo:l}),et=function(){this.x=0,this.y=0,this.id=e(),this.cindex=0,this.colors=[Q],this.overwrite=[],this.isHovered=!1};et.prototype.getColorAsRgbaString=function(t){t=t||0;var e=this.colors[t],i=e[0],s=e[1],r=e[2],h=e[3];return"rgba("+i+","+s+","+r+","+h+")"};var it=Object.freeze({drawTileAtMouseOffset:f,drawTileAt:u,select:d,selectAll:v,hover:g,unHoverAllTiles:p,finalizeBatchOperation:m,clearLatestTileBatch:x,getLatestTileBatchOperation:y,pushTileBatchOperation:w,pushTileBatch:T,getRandomRgbaColors:b,colorArraysMatch:B,getBatchSize:O,createBufferFromBatch:A,batchSizeExceedsLimit:S,getRelativeOffset:k,getTileOffsetAt:M,createTileAtMouseOffset:R,createTileAt:z,getTileByMouseOffset:E,getTileByPosition:I,getTileById:L,isTileInsideView:C,insertSpriteContextAt:P}),st=function(t){this.instance=t,this.modes={draw:!1,drag:!1,selectAll:!1},this.batches={tiles:[]},this.mx=0,this.my=0,this.hovered=[],this.colorTest=null,this.camera=t.camera,this.sindex=-1,this.stack=[]};t(st,tt),t(st,it);var rt=Object.freeze({resize:H,clear:_,render:F,renderBackground:q,renderGrid:W,renderTiles:V,renderStats:j,renderFPS:N,generateBackground:X}),ht=function(t){this.bg=null,this.ctx=null,this.view=null,this.events={},this.camera=new $(this),this.editor=new st(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},this.createView(),t.width>=0&&t.height>=0?this.resize(t.width,t.height):this.resize(view.width,view.height),this.init()};if(ht.prototype.init=function(){this.renderLoop()},ht.prototype.createView=function(){var t=this.createCanvasBuffer(this.width,this.height);this.ctx=t,this.view=t.canvas},ht.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events[Z].fn(),t.frames++,t.renderLoop()})},ht.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},ht.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");var s=i(t);this.events[s]&&(this.events[s]=null),this.events[s]={fn:e},this.processEmitter(s,e)},ht.prototype.processEmitter=function(t,e){0===this.frames&&t===Z&&(this.states.paused=!1)},ht.prototype.createCanvasBuffer=function(t,e){var i=document.createElement("canvas"),s=i.getContext("2d");return i.width=t,i.height=e,this.applyImageSmoothing(s,!1),s},ht.prototype.applyImageSmoothing=function(t,e){t.imageSmoothingEnabled=e,t.oImageSmoothingEnabled=e,t.msImageSmoothingEnabled=e,t.webkitImageSmoothingEnabled=e},t(ht,rt),"undefined"==typeof window)throw new Error("Please run Picaxo inside a browser");window.Picaxo=ht});
