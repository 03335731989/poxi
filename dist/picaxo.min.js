!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function e(){return U++}function i(t){for(var e=0,i=t.length,s=0;s<i;++s){var r=t.charCodeAt(s);e=(e<<5)-e+r,e|=0}return e}function s(t,e){var i=document.createElement("canvas"),s=i.getContext("2d");return i.width=t,i.height=e,r(s,!1),s}function r(t,e){t.imageSmoothingEnabled=e,t.oImageSmoothingEnabled=e,t.msImageSmoothingEnabled=e,t.webkitImageSmoothingEnabled=e}function h(t){return t>=0?t+1:t<0?t+1:t+1}function n(t,e){var i=1/e;return Math.round(t*i)/i}function a(t){this.sindex<this.stack.length-1&&this.dequeue(this.sindex,this.stack.length-1),this.stack.splice(this.sindex+1,this.stack.length),this.stack.push(t),this.redo(),this.undo(),this.redo()}function o(t,e){var i=this;t+=1;var s=e-(t-1);console.log("Dequeue stack by",s,"operations");for(var r=this.batches,h=0;h<s;++h){var n=t+h,a=(i.stack[n],r.splice(0,1)[0]);console.log(a);for(var o=0;o<a.length;++o){var c=a[o];if(c.overwritten.length){var l=c.overwritten.splice(0,1)[0];c.colors.unshift(c.colors[l])}}for(var f=0;f<this.stack.length;++f)i.stack[f].index-=1}console.log("--")}function c(t,e){t.batch.tiles.map(function(t){var i=t.cindex,s=t.colors.length-1;e===!0?t.cindex-=i>0?1:0:t.cindex+=i<s?1:0})}function l(){return this.stack[this.sindex]}function f(){if(this.sindex>=0){var t=this.currentStackOperation();this.fire(t,!1),this.sindex--}}function u(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,!0)}}function d(){var t=new ot;this.batches.push(t)}function v(){var t=this.batches.length-1;return this.batches[t]}function g(){var t=this.batches.length-1,e=this.batches[t],i=this.createBufferFromBatch(e);e.buffer=i,e.isBuffered=!0,this.enqueue({batch:e,index:t})}function x(){var t=this.getLatestTileBatchOperation();if(!t.tiles.length){var e=this.batches.length-1;this.batches.splice(e,1)}}function p(t,e){this.modes.draw=!0;var i=this.getRelativeOffset(t,e);this.colorTest=this.getRandomRgbaColors(),this.pushTileBatchOperation(),this.createBatchTileAt(i.x,i.y,this.colorTest),this.clearLatestTileBatch()}function y(t,e){this.modes.draw=!1,this.finalizeBatchOperation()}function m(t,e){if(this.modes.draw){var i=this.getRelativeOffset(t,e);this.createBatchTileAt(i.x,i.y,this.colorTest)}}function w(t,e,i){return this.pushTileBatchOperation(),this.createBatchTileAt(t*Y|0,e*Y|0,i),this.finalizeBatchOperation(),tile}function B(){this.modes.selectAll=!0}function T(t,e){this.mx=t,this.my=e,this.unHoverAllTiles();var i=this.getTileByMouseOffset(t,e);null!==i&&(this.hovered.push(i),i.isHovered=!0)}function b(){for(var t=this,e=0;e<this.hovered.length;++e)t.hovered[e].isHovered=!1,t.hovered.splice(e,1)}function O(t,e,i){var s=this.getTileByPosition(t,e),r=this.getLatestTileBatchOperation();if(null!==s){var h=s.colors[s.cindex],n=this.colorArraysMatch(i,h);n||(s.overwritten.unshift(s.cindex),s.colors.unshift(i),r.tiles.push(s))}else{var a=this.createTileAt(t,e);a.colors.unshift(i),r.tiles.push(a)}}function A(){var t=256,e=Math.random()*t|0,i=Math.random()*t|0,s=Math.random()*t|0;return[e,i,s,1]}function R(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function k(t){for(var e=(st.MAX_W,st.MAX_H,[]),i=[],s=t.tiles,r=0;r<s.length;++r){var h=s[r];e.push(h.x),i.push(h.y)}e.sort(function(t,e){return t-e}),i.sort(function(t,e){return t-e});var n=e.length-1,a=e[0]/Y|0,o=i[0]/Y|0,c=((e[n]-e[0])/Y|0)+1,l=((i[n]-i[0])/Y|0)+1;return{x:a,y:o,w:c,h:l}}function M(t){var e=t.tiles,i=this.getBatchBoundings(t),r=s(i.w,i.h);r.clearRect(0,0,i.w,i.h);for(var h=(i.w,i.x),n=i.y,a=0;a<e.length;++a){var o=e[a],c=(o.colors[o.cindex],o.x/Y-h),l=o.y/Y-n;r.fillStyle=o.getColorAsRgbaString(),r.fillRect(c,l,1,1)}var f=new ct(r,h,n);return f}function S(t){var e=this.getBatchBoundings(t);return e.w>=st.MIN_W&&e.h>=st.MIN_W}function E(t,e){var i=this.camera.getRelativeOffset(t,e),s=this.getTileOffsetAt(i.x,i.y);return s}function I(t,e){var i=this.getRelativeOffset(t,e),s=this.createTileAt(i.x,i.y);return s}function z(t,e){var i=new at;if(this.offsetExceedsIntegerLimit(t,e))throw new Error("Tile position exceeds 32-bit integer limit!");return i.x=t,i.y=e,i}function L(t,e){return Math.abs(t)>tt||Math.abs(e)>tt}function P(t,e){var i=this.getRelativeOffset(t,e),s=this.getTileByPosition(i.x,i.y);return s}function C(t,e){for(var i=null,s=this.batches,r=0;r<s.length;++r)for(var h=s[r].tiles,n=0;n<h.length;++n){var a=h[n];a.x===t&&a.y===e&&(i=a)}return i}function H(t,e){var i=Y/2,s=n(t-i,Y),r=n(e-i,Y);return{x:s,y:r}}function _(t){for(var e=this.batches,i=0;i<e.length;++i)for(var s=e[i],r=0;r<s.length;++r)if(s[r].id===t)return tile;return null}function F(t){var e=this.camera.s,i=this.camera.width,s=this.camera.height,r=Y*e,h=Y*e,n=t.x*e+this.camera.x,a=t.y*e+this.camera.y;return n+r>=0&&n<=i&&a+h>=0&&a<=s}function q(t,e,i,s,r){var h=this;t*=Y,e*=Y,this.pushTileBatchOperation();for(var n=(this.getLatestTileBatchOperation(),0);n<s;++n)for(var a=0;a<i;++a)h.createBatchTileAt(t+a*Y,e+n*Y,r);this.finalizeBatchOperation()}function W(t,e,i){var s=this,r=t.canvas,h=r.width,n=r.height,a=t.getImageData(0,0,h,n).data,o=this.getRelativeOffset(e,i),c=o.x,l=o.y;this.pushTileBatchOperation();for(var f=(this.getLatestTileBatchOperation(),0);f<n;++f)for(var u=0;u<h;++u){var d=4*(u+f*h),v=a[d+3];if(!(v<=0)){var g=a[d+0],x=a[d+1],p=a[d+2];v=Math.round(v*et*10)/10;s.createBatchTileAt(c+u*Y,l+f*Y,[g,x,p,v])}}this.finalizeBatchOperation()}function D(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,r(this.ctx,!1),this.camera.resize(t,e),this.generateBackground(),this.clear(),this.render()}function V(){this.ctx.clearRect(0,0,this.width,this.height)}function j(){this.renderBackground(),this.renderTileBatches(),this.camera.s>Z+it&&this.renderGrid(),this.renderStats()}function N(){var t=this.camera.width,e=this.camera.height;this.ctx.drawImage(this.bg,0,0,t,e,0,0,t,e)}function X(){var t=this.ctx,e=Y*this.camera.s|0,i=this.camera.x,s=this.camera.y,r=this.camera.width,h=this.camera.height;t.lineWidth=.25,t.strokeStyle="rgba(51,51,51,0.75)",t.beginPath();for(var n=i%e|0;n<r;n+=e)t.moveTo(n,0),t.lineTo(n,h);for(var a=s%e|0;a<h;a+=e)t.moveTo(0,a),t.lineTo(r,a);t.stroke(),t.closePath()}function G(){for(var t=this,e=this.ctx,i=this.camera.x,s=this.camera.y,r=this.camera.s,h=Y*r|0,n=Y*r|0,a=(this.editor.modes.selectAll,this.editor.batches),o=a.length,c=0;c<o;++c){var l=a[c];if(l.isBuffered){var f=l.buffer.x*Y,u=l.buffer.y*Y,d=i+f*r|0,v=s+u*r|0,g=l.buffer.width*Y,x=l.buffer.height*Y;e.drawImage(l.buffer.view,0,0,0|g,0|x,d,v,g*Y*r|0,x*Y*r|0)}}for(var p=0;p<o;++p){var y=a[p];if(!y.isBuffered)for(var m=y.tiles,w=0;w<m.length;++w){var B=m[w];if(t.editor.isTileInsideView(B)){var T=i+B.x*r|0,b=s+B.y*r|0,O=B.colors[B.cindex];e.fillStyle="rgba("+O[0]+","+O[1]+","+O[2]+","+O[3]+")",e.fillRect(T,b,h,n)}}}for(var A=this.editor.hovered,R=0;R<A.length;++R){var k=A[R],M=i+k.x*r|0,S=s+k.y*r|0,E=k.colors[k.cindex],I=E[0],z=E[1],L=E[2],P=E[3]/1.5;e.clearRect(M,S,h,n),e.fillStyle="rgba("+I+","+z+","+L+","+P+")",e.fillRect(M,S,h,n)}if(!A.length){var C=this.editor.mx,H=this.editor.my,_=this.editor.getRelativeOffset(C,H),F=_.x,q=_.y,W=i+F*r|0,D=s+q*r|0;e.fillStyle="rgba(255, 255, 255, 0.1)",e.fillRect(W,D,h,n)}}function J(){this.ctx.fillStyle="#ffffff";var t=this.editor.mx,e=this.editor.my,i=this.editor.getRelativeOffset(t,e),s=i.x,r=i.y,h=this.editor.getTileByPosition(s,r);if(this.ctx.fillText("x:"+s+", y:"+r,16,32),null!==h){var n=h.colors[h.cindex],a=n[0],o=n[1],c=n[2],l=n[3];this.ctx.fillText(a+","+o+","+c+","+l,16,48)}this.renderFPS()}function K(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillText(1e3/e|0,16,16)}function Q(){var t=8,e=this.width,i=this.height,r=(s(e,i),document.createElement("canvas")),h=r.getContext("2d");r.width=e,r.height=i,this.bg=r,h.fillStyle="#1f1f1f",h.fillRect(0,0,e,i),h.fillStyle="#212121";for(var n=0;n<i;n+=2*t)for(var a=0;a<e;a+=2*t)h.fillRect(a,n,t,t),h.fillRect(a,n,t,t);for(var o=t;o<i;o+=2*t)for(var c=t;c<e;c+=2*t)h.fillRect(c,o,t,t)}var U=0,Y=8,Z=.5,$=35,tt=Math.pow(2,31)-1,et=.00392,it=1,st={MIN_W:128,MIN_H:128,MAX_W:1048,MAX_H:1048},rt=i("draw"),ht=function(t){this.x=0,this.y=0,this.s=Z+6,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};ht.prototype.scale=function(t){t=42*t/(Math.hypot(this.width,this.height)/2)*h(this.s);var e=this.s;this.s+t<=Z?this.s=Z:this.s+t>=$?this.s=$:this.s+=t,this.s=n(this.s,.125),this.x-=this.lx*(h(this.s)-h(e)),this.y-=this.ly*(h(this.s)-h(e))},ht.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},ht.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.clear(),this.instance.render()},ht.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,s=(e-this.y)/this.s;return{x:i,y:s}},ht.prototype.resize=function(t,e){this.width=t,this.height=e};var nt=Object.freeze({enqueue:a,dequeue:o,fire:c,currentStackOperation:l,undo:f,redo:u}),at=function(){this.x=0,this.y=0,this.id=e(),this.cindex=0,this.colors=[],this.overwritten=[],this.isHovered=!1};at.prototype.getColorAsRgbaString=function(t){var e=this.colors[t||0],i=e[0],s=e[1],r=e[2],h=e[3];return"rgba("+i+","+s+","+r+","+h+")"};var ot=function(){this.tiles=[],this.buffer=null,this.isBuffered=!1},ct=function(t,e,i){this.x=e,this.y=i;var s=t.canvas;this.view=s,this.width=s.width,this.height=s.height,this.context=t,this.tiles=[]},lt=Object.freeze({pushTileBatchOperation:d,getLatestTileBatchOperation:v,finalizeBatchOperation:g,clearLatestTileBatch:x,startBatchedDrawing:p,stopBatchedDrawing:y,drawTileAtMouseOffset:m,drawTileAt:w,selectAll:B,hover:T,unHoverAllTiles:b,createBatchTileAt:O,getRandomRgbaColors:A,colorArraysMatch:R,getBatchBoundings:k,createBufferFromBatch:M,batchSizeExceedsBounds:S,getRelativeOffset:E,createTileAtMouseOffset:I,createTileAt:z,offsetExceedsIntegerLimit:L,getTileByMouseOffset:P,getTileByPosition:C,getTileOffsetAt:H,getTileById:_,isTileInsideView:F,insertRectangleAt:q,insertSpriteContextAt:W}),ft=function(t){this.instance=t,this.modes={draw:!1,selectAll:!1},this.batches=[],this.mx=-Y,this.my=-Y,this.hovered=[],this.colorTest=null,this.camera=t.camera,this.sindex=-1,this.stack=[]};t(ft,nt),t(ft,lt);var ut=Object.freeze({resize:D,clear:V,render:j,renderBackground:N,renderGrid:X,renderTileBatches:G,renderStats:J,renderFPS:K,generateBackground:Q}),dt=function(t){this.bg=null,this.ctx=null,this.view=null,this.events={},this.camera=new ht(this),this.editor=new ft(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},this.createView(),t.width>=0&&t.height>=0?this.resize(t.width,t.height):this.resize(view.width,view.height),this.init()};if(dt.prototype.init=function(){this.renderLoop()},dt.prototype.createView=function(){var t=s(this.width,this.height);this.ctx=t,this.view=t.canvas},dt.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events[rt].fn(),t.frames++,t.renderLoop()})},dt.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},dt.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");var s=i(t);this.events[s]&&(this.events[s]=null),this.events[s]={fn:e},this.processEmitter(s,e)},dt.prototype.processEmitter=function(t,e){0===this.frames&&t===rt&&(this.states.paused=!1)},t(dt,ut),"undefined"==typeof window)throw new Error("Please run Picaxo inside a browser");window.Picaxo=dt});
