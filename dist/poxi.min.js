!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function e(){return bt++}function i(t){for(var e=0,i=t.length,s=0;s<i;++s){var r=t.charCodeAt(s);e=(e<<5)-e+r,e|=0}return e}function s(t,e){var i=document.createElement("canvas");i.width=t,i.height=e;var s=i.getContext("2d");return r(s,!1),s}function r(t,e){t.imageSmoothingEnabled=e,t.oImageSmoothingEnabled=e,t.msImageSmoothingEnabled=e,t.webkitImageSmoothingEnabled=e}function h(t){return Math.round(t*zt*10)/10}function n(t){var e=t[0],i=t[1],s=t[2],r=t[3];return"rgba("+e+","+i+","+s+","+r+")"}function a(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function o(t){return a(t,At)}function c(t,e){return t-e}function l(t){return t>=0?t+1:t<0?t+1:t+1}function f(t,e){var i=1/e;return Math.round(t*i)/i}function u(t,e,i,s,r,h,n,a){var o=Math.max(t,r),c=Math.min(t+i,r+n),l=Math.max(e,h),f=Math.min(e+s,h+a);return c>=o&&f>=l}function d(t){this.refreshStack(),this.stack.push(t),this.redo(),this.undo(),this.redo()}function g(){this.sindex<this.stack.length-1?this.dequeue(this.sindex,this.stack.length-1):this.stack.splice(this.sindex+1,this.stack.length)}function v(t,e){var i=this;t+=1;for(var s=e-(t-1),r=(this.batches,s);r>0;--r)i.batches.splice(t+r-1,1),i.refreshBatches(),i.stack.splice(t+r-1,1)}function p(t,e){t.batch.tiles.map(function(t){t.cindex;e?t.cindex-=t.cindex>0?1:0:t.cindex+=t.cindex<t.colors.length-1?1:0})}function x(){return this.stack[this.sindex]}function y(){if(this.sindex>=0){var t=this.currentStackOperation();this.fire(t,!1),this.sindex--}}function B(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,!0)}}function w(){this.modes.selectAll=!0}function T(t,e){this.mx=t,this.my=e}function m(t,e){var i=this.getRelativeOffset(t,e);this.eraseTileAt(i.x,i.y)}function b(t,e){var i=this.getStackRelativeTileAt(t,e);if(this.pushTileBatchOperation(),null!==i){i.colors.shift();this.createBatchTileAt(i.x,i.y,[0,0,0,0])}this.finalizeBatchOperation()}function A(t,e){if(this.modes.draw){var i=this.getRelativeOffset(t,e);this.createBatchTileAt(i.x,i.y,this.colorTest)}}function O(t,e,i){this.pushTileBatchOperation(),this.createBatchTileAt(0|t,0|e,i),this.finalizeBatchOperation()}function k(t,e){var i=this.camera.getRelativeOffset(t,e),s=this.getTileOffsetAt(i.x,i.y);return s}function R(t,e){var i=this.getRelativeOffset(t,e),s=this.createTileAt(i.x,i.y);return s}function S(t,e){var i=new qt;if(this.offsetExceedsIntegerLimit(t,e))throw new Error("Tile position exceeds 32-bit integer limit!");return i.x=0|t,i.y=0|e,i}function M(t,e){var i=this.getRelativeOffset(t,e),s=this.getTileAt(i.x,i.y);return s}function C(t,e){for(var i=null,s=this.batches,r=0;r<s.length;++r)for(var h=s[r].tiles,n=0;n<h.length;++n){var a=h[n];a.x===t&&a.y===e&&(i=a)}return i}function I(t,e){var i=this.getRelativeOffset(t,e),s=this.getStackRelativeTileAt(i.x,i.y);return s}function z(t,e){for(var i=null,s=this.sindex,r=this.batches,h=0;h<r.length;++h){var n=r[h].tiles;if(!(s-h<0))for(var a=0;a<n.length;++a){var o=n[a];o.x===t&&o.y===e&&(i=o)}}return i}function E(t,e){var i=Ot/2,s=f(t-i,Ot),r=f(e-i,Ot);return{x:s/Ot,y:r/Ot}}function L(t){for(var e=this.batches,i=0;i<e.length;++i)for(var s=e[i].tiles,r=0;r<s.length;++r){var h=s[r];if(h.id===t)return h}return null}function P(){var t=256,e=Math.random()*t|0,i=Math.random()*t|0,s=Math.random()*t|0;return[e,i,s,1]}function j(t,e){for(var i=null,s=this.batches,r=0;r<s.length;++r){var h=s[r],n=h.getTileColorAt(t,e);null!==n&&(i=n)}return i}function D(t,e){for(var i=null,s=this.sindex,r=this.batches,h=0;h<r.length;++h){var n=r[h];if(!(s-h<0)){var a=n.getTileColorAt(t,e);null!==a&&(i=a)}}return i}function N(t,e){var i=this.getRelativeOffset(t,e);return this.getStackRelativeTileColorAt(i.x,i.y)}function _(t){var e=this.camera.s,i=this.camera.width,s=this.camera.height,r=Ot*e,h=Ot*e,n=t.x*Ot*e+this.camera.x,a=t.y*Ot*e+this.camera.y;return n+r>=0&&n-r<=i&&a+h>=0&&a-h<=s}function q(){var t=new Vt;this.batches.push(t)}function F(){for(var t=this.batches,e=0;e<t.length;++e){var i=t[e];i.index=e}}function H(){var t=this.batches.length-1,e=this.batches[t];if(e.exceedsBounds()&&!e.isRawBuffer)e.renderBuffer();else{if(e.isEmpty())return this.batches.splice(t,1),void this.refreshBatches();if(e.isBackground){var i=this.currentStackOperation();if(i&&i.batch.isBackground&&a(e.bgcolor,i.batch.bgcolor))return}}this.enqueue({batch:e}),this.refreshBatches()}function V(){var t=this.batches.length-1;return this.batches[t]}function W(){var t=this.getLatestTileBatchOperation();if(!t.tiles.length){var e=this.batches.length-1;this.batches.splice(e,1)}}function G(t,e){this.modes.draw=!0;var i=this.getRelativeOffset(t,e);this.colorTest=this.getRandomRgbaColors(),this.pushTileBatchOperation(),this.createBatchTileAt(i.x,i.y,this.colorTest)}function U(t,e){this.modes.draw=!1,this.finalizeBatchOperation(),this.clearLatestTileBatch()}function J(t,e,i){var s=this.getTileAt(t,e),r=this.getLatestTileBatchOperation();if(null===s||!s.colorMatchesWithTile(i)&&s.colors[s.cindex][3]!==Mt){var h=this.createTileAt(t,e);h.colors.unshift(i),r.addTile(h)}}function K(t){for(var e=t.id,i=this.batches,s=0;s<i.length;++s)for(var r=i[s].tiles,h=0;h<r.length;++h){var n=r[h];if(n.id===e)return i[s]}return null}function Q(t,e){for(var i=this.batches,s=0;s<i.length;++s){var r=i[s];r.isBackground&&r.renderBackground(t,e,r.bgcolor)}}function X(t,e){var i=this.getAbsoluteBoundings(this.batches),s=u(i.x,i.y,i.w,i.h,t,e,0,0);return s}function Y(t){for(var e=[],i=[],s=[],r=[],h=0;h<t.length;++h){var n=t[h],a=n.getBoundings();e.push(a.x),i.push(a.y),s.push(a.x+a.w),r.push(a.y+a.h)}e.sort(c),i.sort(c),s.sort(c),r.sort(c);var o=0|e[0],l=0|i[0],f=s.length-1,u=-o+s[f],d=-l+r[f];return{x:o,y:l,w:u,h:d}}function Z(t){o(t);this.pushTileBatchOperation();var e=this.getLatestTileBatchOperation();e.isBackground=!0,e.renderBackground(this.camera.width,this.camera.height,t),this.createBatchTileAt(0,0,t),this.finalizeBatchOperation()}function $(t,e,i,s){var r=this;if(a(s,i))return!1;for(var h=[{x:t,y:e}],n=this.getLatestTileBatchOperation();h.length>0;){var o=h.pop(),c=o.x,l=o.y;if(!r.pointInsideAbsoluteBoundings(c,l))return!0;n.getTileColorAt(c,l)||r.createBatchTileAt(c,l,s);var f=r.getTileColorAt(c+1,l),u=r.getTileColorAt(c-1,l),d=r.getTileColorAt(c,l+1),g=r.getTileColorAt(c,l-1);f&&a(f,i)&&h.push({x:c+1,y:l}),u&&a(u,i)&&h.push({x:c-1,y:l}),d&&a(d,i)&&h.push({x:c,y:l+1}),g&&a(g,i)&&h.push({x:c,y:l-1})}return!1}function tt(t,e,i){for(var s=this,r=[{x:t,y:e}],h=this.getLatestTileBatchOperation();r.length>0;){var n=r.pop(),a=n.x,o=n.y;if(!s.pointInsideAbsoluteBoundings(a,o))return!0;h.getTileColorAt(a,o)||s.createBatchTileAt(a,o,i),s.getTileAt(a+1,o)||r.push({x:a+1,y:o}),s.getTileAt(a-1,o)||r.push({x:a-1,y:o}),s.getTileAt(a,o+1)||r.push({x:a,y:o+1}),s.getTileAt(a,o-1)||r.push({x:a,y:o-1})}return!1}function et(t,e,i){if(i=i||[255,255,255,1],i[3]>1)throw new Error("Invalid alpha color!");var s=this.sindex,r=this.getTileColorAt(t,e);this.pushTileBatchOperation();var h=!1;h=null!==r?this.fillBucketColorBased(t,e,r,i):this.fillBucketEmptyTileBased(t,e,i),this.finalizeBatchOperation(),h&&(s<this.sindex&&(this.undo(),this.refreshStack()),this.fillBackground(i))}function it(t,e,i,s){s||(s=[255,255,255,1]),this.insertArc(t,e,i,s)}function st(t,e,i,s){var r=this,h=i,n=0,a=1-h;for(this.pushTileBatchOperation();h>=n;)r.createBatchTileAt(h+t,n+e,s),r.createBatchTileAt(n+t,h+e,s),r.createBatchTileAt(-h+t,n+e,s),r.createBatchTileAt(-n+t,h+e,s),r.createBatchTileAt(-h+t,-n+e,s),r.createBatchTileAt(-n+t,-h+e,s),r.createBatchTileAt(h+t,-n+e,s),r.createBatchTileAt(n+t,-h+e,s),n++,a<=0&&(a+=2*n+1),a>0&&(h--,a+=2*(n-h)+1);this.finalizeBatchOperation()}function rt(t,e,i,s,r){r||(r=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|s,r,!0)}function ht(t,e,i,s,r){r||(r=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|s,r,!1)}function nt(t,e,i,s,r,h){var n=this,a=Math.abs(i),o=Math.abs(s);this.pushTileBatchOperation();for(var c=i<0?-1:1,l=s<0?-1:1,f=t,u=e,d=0;d<o;++d)for(var g=0;g<a;++g)(h||0===g||g>=a-1||0===d||d>=o-1)&&n.createBatchTileAt(f+g*c,u+d*l,r);this.finalizeBatchOperation()}function at(t,e,i){var s=t.canvas,r=s.width,h=s.height,n=(t.getImageData(0,0,r,h).data,this.getRelativeOffset(e,i));this.pushTileBatchOperation();var a=this.getLatestTileBatchOperation();a.createRawBufferAt(t,n.x,n.y),this.finalizeBatchOperation()}function ot(t,e){var i=this,s=t.tiles;this.pushTileBatchOperation();for(var r=0;r<s.length;++r){var h=s[r],n=h.colors[h.cindex],a=e<0?0:255,o=e<0?-e:e,c=Math.round((a-n[0])*o)+n[0],l=Math.round((a-n[1])*o)+n[1],f=Math.round((a-n[2])*o)+n[2],u=n[3];i.createBatchTileAt(h.x,h.y,[c,l,f,u])}this.finalizeBatchOperation()}function ct(t){for(var e=t.tiles,i=0;i<e.length;++i)if(i>0&&i+1<e.length){var s=e[i],r=e[i+1],h=e[i-1];h.x!==s.x&&h.y!==s.y||r.x!==s.x&&r.y!==s.y||h.x===r.x||h.y===r.y||(e.splice(i,1),++i)}}function lt(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,r(this.ctx,!1),this.camera.resize(t,e),this.generateBackground(),this.editor.resizeBackgroundBatches(t,e),this.clear(),this.render()}function ft(){this.ctx.clearRect(0,0,this.width,this.height)}function ut(){this.renderBackground(),this.renderBatches(),this.camera.s>kt+Et&&this.renderGrid(),this.renderStats()}function dt(){var t=this.camera.width,e=this.camera.height;this.ctx.drawImage(this.bg,0,0,t,e,0,0,t,e)}function gt(){var t=this.ctx,e=Ot*this.camera.s|0,i=this.camera.x,s=this.camera.y,r=this.camera.width,h=this.camera.height;t.lineWidth=Lt,t.strokeStyle="rgba(51,51,51,0.75)",t.beginPath();for(var n=i%e|0;n<r;n+=e)t.moveTo(n,0),t.lineTo(n,h);for(var a=s%e|0;a<h;a+=e)t.moveTo(0,a),t.lineTo(r,a);t.stroke(),t.closePath()}function vt(){for(var t=this,e=this.editor.sindex,i=this.editor.stack,s=0;s<i.length;++s){var r=i[s].batch;e-s<0||(r.isBackground?t.drawBackgroundBatch(r):r.isBuffered?t.drawBatchedBuffer(r):t.drawBatchedTiles(r))}if(this.editor.modes.draw){var h=this.editor.batches.length;h>0&&this.drawBatchedTiles(this.editor.batches[h-1])}this.drawHoveredTile()}function pt(t){var e=this.ctx,i=t.bgbuffer,s=0|i.width,r=0|i.height;e.drawImage(i,0,0,s,r,0,0,s,r)}function xt(t){for(var e=this,i=this.camera.x,s=this.camera.y,r=this.camera.s,h=Ot*r|0,n=Ot*r|0,a=this.ctx,o=t.tiles,c=0;c<o.length;++c){var l=o[c];if(e.editor.isTileInsideView(l)){var f=i+l.x*Ot*r|0,u=s+l.y*Ot*r|0,d=l.colors[l.cindex],g=d[0],v=d[1],p=d[2],x=d[3];a.fillStyle="rgba("+g+","+v+","+p+","+x+")",a.fillRect(f,u,h,n)}}}function yt(t){var e=0|this.camera.x,i=0|this.camera.y,s=this.camera.s,r=t.x*Ot,h=t.y*Ot,n=e+r*s|0,a=i+h*s|0,o=t.width*Ot|0,c=t.height*Ot|0;this.ctx.drawImage(t.buffer.view,0,0,o,c,n,a,o*Ot*s|0,c*Ot*s|0)}function Bt(){var t=this.ctx,e=this.camera.x,i=this.camera.y,s=this.camera.s,r=Ot*s|0,h=Ot*s|0,n=this.editor.mx,a=this.editor.my,o=this.editor.getRelativeOffset(n,a),c=o.x*Ot,l=o.y*Ot,f=e+Lt/2+c*s|0,u=i+Lt/2+l*s|0;t.fillStyle="rgba(255, 255, 255, 0.2)",t.fillRect(f,u,r,h)}function wt(){var t=this.editor.mx,e=this.editor.my,i=this.editor.getRelativeOffset(t,e),s=i.x,r=i.y,h=this.editor.getStackRelativeTileColorAt(s,r);if(this.ctx.fillStyle="#ffffff",this.ctx.fillText("x:"+s+", y:"+r,16,32),null!==h){var n=h[0],a=h[1],o=h[2],c=h[3];this.ctx.fillStyle="rgba("+n+","+a+","+o+","+c+")",this.ctx.fillRect(6,42,8,8),this.ctx.fillStyle="#ffffff",this.ctx.fillText(n+","+a+","+o+","+c,20,48)}this.renderFPS()}function Tt(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillText(1e3/e|0,16,16)}function mt(){var t=8,e=this.width,i=this.height,r=(s(e,i),document.createElement("canvas")),h=r.getContext("2d");r.width=e,r.height=i,this.bg=r,h.fillStyle="#1f1f1f",h.fillRect(0,0,e,i),h.fillStyle="#212121";for(var n=0;n<i;n+=2*t)for(var a=0;a<e;a+=2*t)h.fillRect(a,n,t,t),h.fillRect(a,n,t,t);for(var o=t;o<i;o+=2*t)for(var c=t;c<e;c+=2*t)h.fillRect(c,o,t,t)}var bt=0,At=[0,0,0,0],Ot=8,kt=.25,Rt=32,St=.125,Mt=2,Ct=[0,0,0,0],It=Math.pow(2,31)-1,zt=.00392,Et=0,Lt=.25,Pt=56,jt={MIN_W:8,MIN_H:8,MIN_L:32},Dt=i("draw"),Nt=function(t){this.x=0,this.y=0,this.s=kt+6,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};Nt.prototype.scale=function(t){var e=t*Pt/(Math.hypot(this.width,this.height)/2)*l(this.s),i=this.s;this.s+e<=kt?this.s=kt:this.s+e>=Rt?this.s=Rt:this.s+=e,this.s=f(this.s,St),this.x-=this.lx*(l(this.s)-l(i)),this.y-=this.ly*(l(this.s)-l(i))},Nt.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},Nt.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.clear(),this.instance.render()},Nt.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,s=(e-this.y)/this.s;return{x:i,y:s}},Nt.prototype.resize=function(t,e){this.width=t,this.height=e};var _t=Object.freeze({enqueue:d,refreshStack:g,dequeue:v,fire:p,currentStackOperation:x,undo:y,redo:B}),qt=function(){this.x=0,this.y=0,this.id=e(),this.cindex=0,this.colors=[Ct]};qt.prototype.colorMatchesWithTile=function(t){return a(this.colors[this.cindex],t)},qt.prototype.getColorAsRgbaString=function(t){var e=this.colors[t||0],i=e[0],s=e[1],r=e[2],h=e[3];return"rgba("+i+","+s+","+r+","+h+")"};var Ft=Object.freeze({selectAll:w,hover:T,eraseTileAtMouseOffset:m,eraseTileAt:b,drawTileAtMouseOffset:A,drawTileAt:O,getRelativeOffset:k,createTileAtMouseOffset:R,createTileAt:S,getTileByMouseOffset:M,getTileAt:C,getStackRelativeTileByMouseOffset:I,getStackRelativeTileAt:z,getTileOffsetAt:E,getTileById:L,getRandomRgbaColors:P,getTileColorAt:j,getStackRelativeTileColorAt:D,getStackRelativeTileColorByMouseOffset:N,isTileInsideView:_}),Ht=function(t,e,i){this.x=e,this.y=i;var s=t.canvas;this.view=s,this.width=s.width,this.height=s.height,this.context=t,this.tiles=[]},Vt=function(){this.x=0,this.y=0,this.width=0,this.height=0,this.index=0,this.tiles=[],this.buffer=null,this.bgcolor=null,this.bgbuffer=null,this.isBuffered=!1,this.isRawBuffer=!1,this.isBackground=!1};Vt.prototype.renderBackground=function(t,e,i){var r=s(t,e),h=i[0],n=i[1],a=i[2],o=i[3];r.fillStyle="rgba("+h+","+n+","+a+","+o+")",r.fillRect(0,0,t,e),this.bgcolor=i,this.bgbuffer=r.canvas},Vt.prototype.addTile=function(t){this.tiles.push(t),this.updateBoundings()},Vt.prototype.updateBoundings=function(){if(!this.isRawBuffer){var t=this.getBoundings();this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}},Vt.prototype.getBoundings=function(){if(this.isRawBuffer)return{x:this.x,y:this.y,w:this.width,h:this.height};for(var t=[],e=[],i=this.tiles,s=0;s<i.length;++s){var r=i[s];t.push(r.x),e.push(r.y)}t.sort(c),e.sort(c);var h=t.length-1,n=0|t[0],a=0|e[0],o=(t[h]-t[0]|0)+1,l=(e[h]-e[0]|0)+1;return{x:n,y:a,w:o,h:l}},Vt.prototype.createRawBufferAt=function(t,e,i){var s=t.canvas;this.x=e,this.y=i,this.width=s.width,this.height=s.height,this.isBuffered=!0,this.isRawBuffer=!0,this.buffer=new Ht(t,e,i)},Vt.prototype.renderBuffer=function(){for(var t=s(this.width,this.height),e=0|this.x,i=0|this.y,r=this.tiles,h=0;h<r.length;++h){var n=r[h],a=(n.colors[n.cindex],n.x-e|0),o=n.y-i|0;t.fillStyle=n.getColorAsRgbaString(),t.fillRect(a,o,1,1)}this.buffer=new Ht(t,e,i),this.isBuffered=!0,this.updateBoundings()},Vt.prototype.exceedsBounds=function(){if(this.tiles.length>=jt.MIN_L)return!0;var t=this.getBoundings();return t.w-1>=jt.MIN_W||t.h-1>=jt.MIN_H},Vt.prototype.isEmpty=function(){return!this.isBuffered&&!this.isRawBuffer&&!this.isBackground&&this.tiles.length<=0},Vt.prototype.getTileColorAt=function(t,e){if(this.isEmpty())return null;if(this.isRawBuffer){var i=t-this.x,s=e-this.y;if(i<0||s<0)return null;if(i>this.width||this.yy>this.height)return null;var r=this.buffer.context.getImageData(i,s,1,1).data,n=h(r[3]),a=[r[0],r[1],r[2],n];return o(a)||n<=0?null:[r[0],r[1],r[2],n]}var c=this.getTileAt(t,e);return null!==c?c.colors[c.cindex]:null},Vt.prototype.getTileAt=function(t,e){for(var i=this.tiles,s=0;s<i.length;++s){var r=i[s];if(r.x===t&&r.y===e)return r}return null};var Wt=Object.freeze({pushTileBatchOperation:q,refreshBatches:F,finalizeBatchOperation:H,getLatestTileBatchOperation:V,clearLatestTileBatch:W,startBatchedDrawing:G,stopBatchedDrawing:U,createBatchTileAt:J,getBatchByTile:K,resizeBackgroundBatches:Q,pointInsideAbsoluteBoundings:X,getAbsoluteBoundings:Y}),Gt=Object.freeze({fillBackground:Z,fillBucketColorBased:$,fillBucketEmptyTileBased:tt,fillBucket:et,strokeArc:it,insertArc:st,fillRect:rt,strokeRect:ht,insertRectangleAt:nt,drawImage:at}),Ut=Object.freeze({applyColorLightness:ot,applyPixelSmoothing:ct}),Jt=function(t){this.instance=t,this.modes={draw:!1,selectAll:!1},this.batches=[],this.mx=-1,this.my=-1,this.colorTest=null,this.camera=t.camera,this.sindex=-1,this.stack=[]};Jt.prototype.offsetExceedsIntegerLimit=function(t,e){return Math.abs(t)>It||Math.abs(e)>It},t(Jt,_t),t(Jt,Ft),t(Jt,Wt),t(Jt,Gt),t(Jt,Ut);var Kt=Object.freeze({resize:lt,clear:ft,render:ut,renderBackground:dt,renderGrid:gt,renderBatches:vt,drawBackgroundBatch:pt,drawBatchedTiles:xt,drawBatchedBuffer:yt,drawHoveredTile:Bt,renderStats:wt,renderFPS:Tt,generateBackground:mt}),Qt=function(t){this.bg=null,this.ctx=null,this.view=null,this.events={},this.camera=new Nt(this),this.editor=new Jt(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},this.createView(),t.width>=0&&t.height>=0?this.resize(t.width,t.height):this.resize(view.width,view.height),this.init()};if(Qt.prototype.init=function(){this.renderLoop()},Qt.prototype.createView=function(){var t=s(this.width,this.height);this.ctx=t,this.view=t.canvas},Qt.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events[Dt].fn(),t.frames++,t.renderLoop()})},Qt.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},Qt.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");var s=i(t);this.events[s]&&(this.events[s]=null),this.events[s]={fn:e},this.processEmitter(s,e)},Qt.prototype.processEmitter=function(t,e){0===this.frames&&t===Dt&&(this.states.paused=!1)},Qt.prototype.exportAsDataUrl=function(){for(var t=this.editor,e=t.batches,i=t.getAbsoluteBoundings(e),r=i.x,h=i.y,a=i.w,o=i.h,c=s(a,o),l=c.canvas,f=0;f<e.length;++f){var u=e[f];if(u.isBackground)c.fillStyle=n(u.bgcolor),c.fillRect(0,0,l.width,l.height);else if(u.isBuffered)c.drawImage(u.buffer.view,u.x-r|0,u.y-h|0,0|u.width,0|u.height);else if(u.tiles.length)for(var d=u.tiles,g=0;g<d.length;++g){var v=d[g],p=v.x-r|0,x=v.y-h|0,y=n(v.colors[v.cindex]);c.fillStyle=y,c.fillRect(p,x,1,1)}else;}return l.toDataURL()},t(Qt,Kt),"undefined"==typeof window)throw new Error("Please run Poxi inside a browser");window.Poxi=Qt});
