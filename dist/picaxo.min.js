!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t){return t>=0?t+1:t<0?t+1:t+1}function e(t,e){var i=1/e;return Math.round(t*i)/i}function i(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function s(t){this.sindex+t}function h(t){this.stack.splice(this.sindex+1,this.stack.length),this.stack.push(t),this.redo()}function n(t,e){t.batch.map(function(t){console.log(t)})}function r(){return this.stack[this.sindex]}function o(){if(this.sindex>0){this.sindex--;var t=this.currentStackOperation();this.fire(t,0)}}function a(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,1)}}function c(t,e,i){if(this.modes.drag=i,this.modes.draw=!!i,i&&this.modes.draw)this.colorTest=this.setRandomColor(),this.pushTileBatchOperation(),this.pushTileBatch(t,e),this.clearLatestTileBatch();else{var s=this.batches.tiles.length-1;this.enqueue({batch:this.batches.tiles[s],index:s})}}function l(){var t=this.getLatestTileBatchOperation();if(t.length<=0){var e=this.batches.tiles.length-1;this.batches.tiles.splice(e,1)}}function f(){var t=255*Math.random()+1|0,e=255*Math.random()+1|0,i=255*Math.random()+1|0;return[t,e,i,1]}function u(t,i){var s=this.camera.getRelativeOffset(t,i),h=E/2;return s.x=e(s.x-h,E),s.y=e(s.y-h,E),s}function d(t,e){var i=this.getRelativeOffset(t,e),s=new F;return s.x=i.x,s.y=i.y,s}function p(){var t=this.batches.tiles.length-1,e=this.batches.tiles;return e[t]}function v(){var t=[];this.batches.tiles.push(t)}function y(t,e){var i=this.getRelativeOffset(t,e),s=this.findTileAt(i.x,i.y);return s}function x(t,e){for(var i=null,s=this.batches.tiles,h=0;h<s.length;++h)for(var n=s[h],r=0;r<n.length;++r){var o=n[r];o.x===t&&o.y===e&&(i=o)}return i}function w(t,e){var i=this.getTileFromMouseOffset(t,e),s=this.createTileByMouseOffset(t,e),h=[this.colorTest[0],this.colorTest[1],this.colorTest[2],this.colorTest[3]],n=this.getLatestTileBatchOperation();if(null!==i){var r=this.colorArraysMatch(h,i.colors[i.cindex]);r||(i.colors.unshift(h),n.push(i))}else s.colors.push(h),n.push(s)}function g(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function m(){for(var t=this,e=0;e<this.hovered.length;++e)t.hovered[e].isHovered=!1,t.hovered.splice(e,1)}function T(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,this.camera.resize(t,e),this.clear(),this.render()}function O(){this.ctx.clearRect(0,0,this.width,this.height)}function b(){this.renderGrid(),this.renderTiles(),this.renderFPS()}function k(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillStyle="#fff",this.ctx.fillText(1e3/e|0,16,16)}function M(){for(var t=this.ctx,e=this.camera.x,i=this.camera.y,s=this.camera.s,h=E*s|0,n=E*s|0,r=this.editor.batches.tiles,o=0;o<r.length;++o)for(var a=r[o],c=0;c<a.length;++c){var l=a[c],f=e+l.x*s|0,u=i+l.y*s|0,d=l.colors[l.cindex],p=d[0],v=d[1],y=d[2],x=d[3];l.isHovered&&(x/=1.25),t.fillStyle="rgba("+p+","+v+","+y+","+x+")",t.fillRect(f,u,h,n)}}function B(){var t=this.ctx,e=E*this.camera.s|0,i=this.camera.x,s=this.camera.y,h=this.camera.width,n=this.camera.height;t.lineWidth=.25,t.strokeStyle="#333333",t.beginPath();for(var r=i%e|0;r<h;r+=e)t.moveTo(r,0),t.lineTo(r,n);for(var o=s%e|0;o<n;o+=e)t.moveTo(0,o),t.lineTo(h,o);t.stroke(),t.closePath()}var E=8,R=1,L=35,S=function(t){this.x=0,this.y=0,this.s=R+6,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};S.prototype.scale=function(e){e=42*e/(Math.hypot(this.width,this.height)/2)*t(this.s);var i=this.s;this.s+=e,this.s+e<=R&&(this.s=R),this.s+e>=L&&(this.s=L),this.x-=this.lx*(t(this.s)-t(i)),this.y-=this.ly*(t(this.s)-t(i))},S.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},S.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.clear(),this.instance.render()},S.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,s=(e-this.y)/this.s;return{x:i,y:s}},S.prototype.resize=function(t,e){this.width=t,this.height=e};var z=Object.freeze({updateStackIndex:s,enqueue:h,fire:n,currentStackOperation:r,undo:o,redo:a}),F=function(){this.x=0,this.y=0,this.cindex=0,this.colors=[],this.isHovered=!1},A=Object.freeze({select:c,clearLatestTileBatch:l,setRandomColor:f,getRelativeOffset:u,createTileByMouseOffset:d,getLatestTileBatchOperation:p,pushTileBatchOperation:v,getTileFromMouseOffset:y,findTileAt:x,pushTileBatch:w,colorArraysMatch:g,unHoverAllTiles:m}),H=function(t){this.modes={draw:!1,drag:!1},this.batches={tiles:[]},this.hovered=[],this.colorTest=null,this.camera=t.camera,this.sindex=-1,this.stack=[]};H.prototype.drag=function(t,e){this.modes.drag&&this.modes.draw&&this.pushTileBatch(t,e)},H.prototype.hover=function(t,e){this.unHoverAllTiles();var i=this.getTileFromMouseOffset(t,e);null!==i&&(this.hovered.push(i),i.isHovered=!0)},i(H,z),i(H,A);var P=Object.freeze({resize:T,clear:O,render:b,renderFPS:k,renderTiles:M,renderGrid:B}),V=function(t){return this.ctx=null,this.view=null,this.events={},this.camera=new S(this),this.editor=new H(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},t&&this.isViewElement(t)?void this.applyView(t):(this.applyView(t.view),t.width>=0&&t.height>=0?this.resize(t.width,t.height):this.resize(view.width,view.height),void this.init())};if(V.prototype.init=function(){this.renderLoop()},V.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events.draw.fn(),t.frames++,t.renderLoop()})},V.prototype.applyView=function(t){if(!this.isViewElement(t))throw new Error("Invalid view element provided");this.view=t,this.ctx=t.getContext("2d")},V.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},V.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");this.events[t]&&(this.events[t]=null),this.events[t]={fn:e},this.processEmitter(t,e)},V.prototype.processEmitter=function(t,e){0===this.frames&&"draw"===t&&(this.states.paused=!1)},i(V,P),"undefined"==typeof window)throw new Error("Picaxo needs to run as a website");window.Picaxo=V});
