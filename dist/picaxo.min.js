!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function e(){return U++}function i(t){for(var e=0,i=t.length,s=0;s<i;++s){var r=t.charCodeAt(s);e=(e<<5)-e+r,e|=0}return e}function s(t,e){var i=document.createElement("canvas"),s=i.getContext("2d");return i.width=t,i.height=e,r(s,!1),s}function r(t,e){t.imageSmoothingEnabled=e,t.oImageSmoothingEnabled=e,t.msImageSmoothingEnabled=e,t.webkitImageSmoothingEnabled=e}function n(t){return Math.round(t*it*10)/10}function h(t){return t>=0?t+1:t<0?t+1:t+1}function a(t,e){var i=1/e;return Math.round(t*i)/i}function o(t){this.sindex<this.stack.length-1?(console.log(this.sindex,t.index,this.stack.length),this.dequeue(this.sindex,this.stack.length-1)):this.stack.splice(this.sindex+1,this.stack.length),this.stack.push(t),this.redo(),this.undo(),this.redo()}function c(t,e){var i=this;t+=1;for(var s=e-(t-1),r=(this.batches,s);r>0;--r)i.batches.splice(t+r-1,1),i.stack.splice(t+r-1,1)}function f(t,e){t.batch.tiles.map(function(t){t.cindex;e?t.cindex-=t.cindex>0?1:0:t.cindex+=t.cindex<t.colors.length-1?1:0})}function l(){return this.stack[this.sindex]}function u(){if(this.sindex>=0){var t=this.currentStackOperation();this.fire(t,!1),this.sindex--}}function d(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,!0)}}function g(t,e){if(this.modes.draw){var i=this.getRelativeOffset(t,e);this.createBatchTileAt(i.x,i.y,this.colorTest)}}function v(t,e,i){return this.pushTileBatchOperation(),this.createBatchTileAt(t*Y|0,e*Y|0,i),this.finalizeBatchOperation(),tile}function x(){this.modes.selectAll=!0}function p(t,e){this.mx=t,this.my=e,this.unHoverAllTiles();var i=this.getTileByMouseOffset(t,e);null!==i&&(this.hovered.push(i),i.isHovered=!0)}function y(){for(var t=this,e=0;e<this.hovered.length;++e)t.hovered[e].isHovered=!1,t.hovered.splice(e,1)}function m(){var t=256,e=Math.random()*t|0,i=Math.random()*t|0,s=Math.random()*t|0;return[e,i,s,1]}function w(t,e){var i=this.camera.getRelativeOffset(t,e),s=this.getTileOffsetAt(i.x,i.y);return s}function b(t,e){var i=this.getRelativeOffset(t,e),s=this.createTileAt(i.x,i.y);return s}function T(t,e){var i=new ct;if(this.offsetExceedsIntegerLimit(t,e))throw new Error("Tile position exceeds 32-bit integer limit!");return i.x=t,i.y=e,i}function B(t,e){var i=this.getRelativeOffset(t,e),s=this.getTileByPosition(i.x,i.y);return s}function O(t,e){for(var i=null,s=this.batches,r=0;r<s.length;++r)for(var n=s[r].tiles,h=0;h<n.length;++h){var a=n[h];a.x===t&&a.y===e&&(i=a)}return i}function R(t,e){var i=Y/2,s=a(t-i,Y),r=a(e-i,Y);return{x:s,y:r}}function A(t){for(var e=this.batches,i=0;i<e.length;++i)for(var s=e[i],r=0;r<s.length;++r)if(s[r].id===t)return tile;return null}function M(t){var e=this.camera.s,i=this.camera.width,s=this.camera.height,r=Y*e,n=Y*e,h=t.x*e+this.camera.x,a=t.y*e+this.camera.y;return h+r>=0&&h<=i&&a+n>=0&&a<=s}function k(){var t=new ut;this.batches.push(t)}function S(){var t=this.batches.length-1;return this.batches[t]}function I(){var t=this.batches.length-1,e=this.batches[t];e.exceedsBounds()&&!e.isRawBuffer&&e.renderBuffer(),this.enqueue({batch:e,index:t})}function E(){var t=this.getLatestTileBatchOperation();if(!t.tiles.length){var e=this.batches.length-1;this.batches.splice(e,1)}}function L(t,e){this.modes.draw=!0;var i=this.getRelativeOffset(t,e);this.colorTest=this.getRandomRgbaColors(),this.pushTileBatchOperation(),this.createBatchTileAt(i.x,i.y,this.colorTest)}function z(t,e){this.modes.draw=!1,this.finalizeBatchOperation(),this.clearLatestTileBatch()}function P(t,e,i){var s=this.getTileByPosition(t,e),r=this.getLatestTileBatchOperation();if(null===s||!s.colorMatchesWithTile(i)){var n=this.createTileAt(t,e);n.colors.unshift(i),r.tiles.push(n)}}function C(t,e,i,s,r){r||(r=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|s,r,!0)}function H(t,e,i,s,r){r||(r=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|s,r,!1)}function _(t,e,i,s,r,n){var h=this,a=Math.abs(i),o=Math.abs(s);this.pushTileBatchOperation();for(var c=(this.getLatestTileBatchOperation(),i<0?-1:1),f=s<0?-1:1,l=t*Y,u=e*Y,d=0;d<o;++d)for(var g=0;g<a;++g)(n||0===g||g>=a-1||0===d||d>=o-1)&&h.createBatchTileAt(l+g*Y*c,u+d*Y*f,r);this.finalizeBatchOperation()}function j(t,e,i){var s=t.canvas,r=s.width,n=s.height,h=(t.getImageData(0,0,r,n).data,this.getRelativeOffset(e,i)),a=h.x,o=h.y;this.pushTileBatchOperation();var c=this.getLatestTileBatchOperation();c.isBuffered=!0,c.isRawBuffer=!0,c.buffer=new lt(t,a/Y,o/Y),this.finalizeBatchOperation()}function N(t,e){for(var i=t.tiles,s=0;s<i.length;++s){var r=i[s],n=r.colors[r.cindex],h=e<0?0:255,a=e<0?-e:e,o=Math.round((h-n[0])*a)+n[0],c=Math.round((h-n[1])*a)+n[1],f=Math.round((h-n[2])*a)+n[2],l=n[3];r.colors.unshift([o,c,f,l])}}function W(t){for(var e=t.tiles,i=0;i<e.length;++i)if(i>0&&i+1<e.length){var s=e[i],r=e[i+1],n=e[i-1];n.x!==s.x&&n.y!==s.y||r.x!==s.x&&r.y!==s.y||n.x===r.x||n.y===r.y||(e.splice(i,1),++i)}}function q(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,r(this.ctx,!1),this.camera.resize(t,e),this.generateBackground(),this.clear(),this.render()}function D(){this.ctx.clearRect(0,0,this.width,this.height)}function F(){this.renderBackground(),this.renderTileBatches(),this.camera.s>Z+st&&this.renderGrid(),this.renderStats()}function V(){var t=this.camera.width,e=this.camera.height;this.ctx.drawImage(this.bg,0,0,t,e,0,0,t,e)}function G(){var t=this.ctx,e=Y*this.camera.s|0,i=this.camera.x,s=this.camera.y,r=this.camera.width,n=this.camera.height;t.lineWidth=.25,t.strokeStyle="rgba(51,51,51,0.75)",t.beginPath();for(var h=i%e|0;h<r;h+=e)t.moveTo(h,0),t.lineTo(h,n);for(var a=s%e|0;a<n;a+=e)t.moveTo(0,a),t.lineTo(r,a);t.stroke(),t.closePath()}function X(){for(var t=this,e=this.ctx,i=this.camera.x,s=this.camera.y,r=this.camera.s,n=Y*r|0,h=Y*r|0,a=this.editor.sindex,o=(this.editor.modes.selectAll,this.editor.batches),c=o.length,f=0;f<c;++f){var l=o[f];if(l.isBuffered&&!(a-f<0)){var u=l.buffer.x*Y,d=l.buffer.y*Y,g=i+u*r|0,v=s+d*r|0,x=l.buffer.width*Y|0,p=l.buffer.height*Y|0;e.drawImage(l.buffer.view,0,0,x,p,g,v,x*Y*r|0,p*Y*r|0)}}for(var y=0;y<c;++y){var m=o[y];if(!m.isBuffered)for(var w=m.tiles,b=0;b<w.length;++b){var T=w[b];if(t.editor.isTileInsideView(T)){var B=i+T.x*r|0,O=s+T.y*r|0,R=T.colors[T.cindex];e.fillStyle="rgba("+R[0]+","+R[1]+","+R[2]+","+R[3]+")",e.fillRect(B,O,n,h)}}}for(var A=this.editor.hovered,M=0;M<A.length;++M){var k=A[M],S=i+k.x*r|0,I=s+k.y*r|0,E=k.colors[k.cindex],L=E[0],z=E[1],P=E[2],C=E[3]/1.5;e.clearRect(S,I,n,h),e.fillStyle="rgba("+L+","+z+","+P+","+C+")",e.fillRect(S,I,n,h)}if(!A.length){var H=this.editor.mx,_=this.editor.my,j=this.editor.getRelativeOffset(H,_),N=j.x,W=j.y,q=i+N*r|0,D=s+W*r|0;e.fillStyle="rgba(255, 255, 255, 0.1)",e.fillRect(q,D,n,h)}}function J(){this.ctx.fillStyle="#ffffff";var t=this.editor.mx,e=this.editor.my,i=this.editor.getRelativeOffset(t,e),s=i.x,r=i.y,n=this.editor.getTileByPosition(s,r);if(this.ctx.fillText("x:"+s/Y+", y:"+r/Y,16,32),null!==n){var h=n.colors[n.cindex],a=h[0],o=h[1],c=h[2],f=h[3];this.ctx.fillText(a+","+o+","+c+","+f,16,48)}this.renderFPS()}function K(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillText(1e3/e|0,16,16)}function Q(){var t=8,e=this.width,i=this.height,r=(s(e,i),document.createElement("canvas")),n=r.getContext("2d");r.width=e,r.height=i,this.bg=r,n.fillStyle="#1f1f1f",n.fillRect(0,0,e,i),n.fillStyle="#212121";for(var h=0;h<i;h+=2*t)for(var a=0;a<e;a+=2*t)n.fillRect(a,h,t,t),n.fillRect(a,h,t,t);for(var o=t;o<i;o+=2*t)for(var c=t;c<e;c+=2*t)n.fillRect(c,o,t,t)}var U=0,Y=8,Z=.25,$=32,tt=[0,0,0,0],et=Math.pow(2,31)-1,it=.00392,st=0,rt=56,nt={MIN_W:8,MIN_H:8,MIN_L:32},ht=i("draw"),at=function(t){this.x=0,this.y=0,this.s=Z+6,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};at.prototype.scale=function(t){var e=t*rt/(Math.hypot(this.width,this.height)/2)*h(this.s),i=this.s;this.s+e<=Z?this.s=Z:this.s+e>=$?this.s=$:this.s+=e,this.s=a(this.s,.125),this.x-=this.lx*(h(this.s)-h(i)),this.y-=this.ly*(h(this.s)-h(i))},at.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},at.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.clear(),this.instance.render()},at.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,s=(e-this.y)/this.s;return{x:i,y:s}},at.prototype.resize=function(t,e){this.width=t,this.height=e};var ot=Object.freeze({enqueue:o,dequeue:c,fire:f,currentStackOperation:l,undo:u,redo:d}),ct=function(){this.x=0,this.y=0,this.id=e(),this.cindex=0,this.colors=[tt],this.isHovered=!1};ct.prototype.colorMatchesWithTile=function(t){var e=this.colors[this.cindex];return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},ct.prototype.getColorAsRgbaString=function(t){var e=this.colors[t||0],i=e[0],s=e[1],r=e[2],n=e[3];return"rgba("+i+","+s+","+r+","+n+")"};var ft=Object.freeze({drawTileAtMouseOffset:g,drawTileAt:v,selectAll:x,hover:p,unHoverAllTiles:y,getRandomRgbaColors:m,getRelativeOffset:w,createTileAtMouseOffset:b,createTileAt:T,getTileByMouseOffset:B,getTileByPosition:O,getTileOffsetAt:R,getTileById:A,isTileInsideView:M}),lt=function(t,e,i){this.x=e,this.y=i;var s=t.canvas;this.view=s,this.width=s.width,this.height=s.height,this.context=t,this.tiles=[]},ut=function(){this.tiles=[],this.buffer=null,this.isBuffered=!1,this.isRawBuffer=!1};ut.prototype.getBoundings=function(){for(var t=(nt.MAX_W,nt.MAX_H,[]),e=[],i=this.tiles,s=0;s<i.length;++s){var r=i[s];t.push(r.x),e.push(r.y)}t.sort(function(t,e){return t-e}),e.sort(function(t,e){return t-e});var n=t.length-1,h=t[0]/Y|0,a=e[0]/Y|0,o=((t[n]-t[0])/Y|0)+1,c=((e[n]-e[0])/Y|0)+1;return{x:h,y:a,w:o,h:c}},ut.prototype.renderBuffer=function(){for(var t=this.getBoundings(),e=s(t.w,t.h),i=(t.w,t.x),r=t.y,n=this.tiles,h=0;h<n.length;++h){var a=n[h],o=(a.colors[a.cindex],a.x/Y-i),c=a.y/Y-r;e.fillStyle=a.getColorAsRgbaString(),e.fillRect(o,c,1,1)}this.buffer=new lt(e,i,r),this.isBuffered=!0},ut.prototype.exceedsBounds=function(){if(this.tiles.length>=nt.MIN_L)return!0;var t=this.getBoundings();return t.w-1>=nt.MIN_W||t.h-1>=nt.MIN_H},ut.prototype.getTileColorAt=function(t,e){if(!this.isBuffered)return[0,0,0,0];var i=this.buffer.context.getImageData(t,e,1,1).data,s=n(i[3]),r=[i[0],i[1],i[2],s];return r};var dt=Object.freeze({pushTileBatchOperation:k,getLatestTileBatchOperation:S,finalizeBatchOperation:I,clearLatestTileBatch:E,startBatchedDrawing:L,stopBatchedDrawing:z,createBatchTileAt:P}),gt=Object.freeze({fillRect:C,strokeRect:H,insertRectangleAt:_,insertSpriteContextAt:j}),vt=Object.freeze({applyColorLightness:N,applyPixelSmoothing:W}),xt=function(t){this.instance=t,this.modes={draw:!1,selectAll:!1},this.batches=[],this.mx=-Y,this.my=-Y,this.hovered=[],this.colorTest=null,this.camera=t.camera,this.sindex=-1,this.stack=[]};xt.prototype.offsetExceedsIntegerLimit=function(t,e){return Math.abs(t)>et||Math.abs(e)>et},t(xt,ot),t(xt,ft),t(xt,dt),t(xt,gt),t(xt,vt);var pt=Object.freeze({resize:q,clear:D,render:F,renderBackground:V,renderGrid:G,renderTileBatches:X,renderStats:J,renderFPS:K,generateBackground:Q}),yt=function(t){this.bg=null,this.ctx=null,this.view=null,this.events={},this.camera=new at(this),this.editor=new xt(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},this.createView(),t.width>=0&&t.height>=0?this.resize(t.width,t.height):this.resize(view.width,view.height),this.init()};if(yt.prototype.init=function(){this.renderLoop()},yt.prototype.createView=function(){var t=s(this.width,this.height);this.ctx=t,this.view=t.canvas},yt.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events[ht].fn(),t.frames++,t.renderLoop()})},yt.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},yt.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");var s=i(t);this.events[s]&&(this.events[s]=null),this.events[s]={fn:e},this.processEmitter(s,e)},yt.prototype.processEmitter=function(t,e){0===this.frames&&t===ht&&(this.states.paused=!1)},t(yt,pt),"undefined"==typeof window)throw new Error("Please run Picaxo inside a browser");window.Picaxo=yt});
