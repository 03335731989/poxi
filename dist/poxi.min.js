!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function e(){return Zt++}function i(t){for(var e=0,i=t.length,r=0;r<i;++r){var s=t.charCodeAt(r);e=(e<<5)-e+s,e|=0}return e}function r(t,e){var i=document.createElement("canvas");i.width=t,i.height=e;var r=i.getContext("2d");return s(r,!1),r}function s(t,e){t.imageSmoothingEnabled=e,t.oImageSmoothingEnabled=e,t.msImageSmoothingEnabled=e,t.webkitImageSmoothingEnabled=e}function n(t){return Math.round(t*le*10)/10}function h(t){var e=t[0]/255,i=t[1]/255,r=t[2]/255,s=t[3];return[e,i,r,s]}function a(t){var e=t[0],i=t[1],r=t[2],s=t[3];return"rgba("+e+","+i+","+r+","+s+")"}function o(t){var e=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16);return[e,i,r,1]}function c(t){var e=t[0],i=t[1],r=t[2];t[3];return"#"+("0"+parseInt(e,10).toString(16)).slice(-2)+("0"+parseInt(i,10).toString(16)).slice(-2)+("0"+parseInt(r,10).toString(16)).slice(-2)}function l(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function u(t){return l(t,$t)}function f(t,e){return t-e}function d(t){if(!Te)throw new Error("Your browser doesn't support WebGL.");var e={alpha:!1,antialias:!1,premultipliedAlpha:!1,stencil:!1,preserveDrawingBuffer:!1};return t.getContext("webgl",e)||t.getContext("experimental-webgl",e)}function g(t){return t>=0?t+1:t<0?t+1:t+1}function v(t,e){var i=1/e;return Math.round(t*i)/i}function x(t,e,i,r,s,n,h,a){var o=Math.max(t,s),c=Math.min(t+i,s+h),l=Math.max(e,n),u=Math.min(e+r,n+a);return c>=o&&u>=l}function p(t,e,i){if(i=i||[255,255,255,1],i[3]>1)throw new Error("Invalid alpha color!");var r=this.getStackRelativeTileColorAt(t,e)||oe;if(!l(r,i)){this.refreshStack(),this.updateGlobalBoundings();this.sindex;this.pushTileBatchOperation();var s=this.getLatestTileBatchOperation(),n=this.binaryFloodFill(t,e,r,i);s.createRawBufferAt(n.buffer,n.x,n.y),s.updateBoundings(),s.tiles.length&&this.batchTilesToRawBuffer(s,i),this.finalizeBatchOperation()}}function T(t,e,i,s){for(var n=this,h=this.boundings,o=h.x,c=h.y,l=h.w,u=h.h,d=0===i[3],g=l*u,v=new Uint8ClampedArray(l*u),x=0;x<g;++x){var p=x%l,T=x/l|0,y=n.getTileColorAt(o+p,c+T);if(d){if(null!==y)continue}else{if(null===y)continue;if(i[0]!==y[0]||i[1]!==y[1]||i[2]!==y[2])continue}v[T*l+p]=1}for(var b=[{x:t,y:e}];b.length>0;){var w=b.pop(),B=w.x,m=w.y,R=m*l+B;1===v[R]&&(v[R]=2);var A=(m-1)*l+B,E=m*l+(B+1),S=(m+1)*l+B,O=m*l+(B-1);A<g&&1===v[A]&&b.push({x:B,y:m-1}),E<g&&1===v[E]&&b.push({x:B+1,y:m}),S<g&&1===v[S]&&b.push({x:B,y:m+1}),O<g&&1===v[O]&&b.push({x:B-1,y:m})}for(var k=[],_=[],I=0,C=v.length;I<C;++I){var L=I%l,D=I/l|0;2===v[I]&&(k.push(L),_.push(D))}k.sort(f),_.sort(f);var U=0|k[0],M=0|_[0],G=(k[k.length-1]-U|0)+1,z=(_[_.length-1]-M|0)+1,P=r(G,z);P.fillStyle=a(s);for(var F=0;F<G*z;++F){var N=F%G,j=F/G|0,X=U+N,W=M+j;2===v[W*l+X]&&P.fillRect(N,j,1,1)}return v=null,k=null,_=null,{x:U,y:M,width:G,height:z,buffer:P}}function y(t){u(t);this.pushTileBatchOperation();var e=this.getLatestTileBatchOperation();e.isBackground=!0,e.renderBackground(this.camera.width,this.camera.height,t),e.updateBoundings(),this.finalizeBatchOperation()}function b(t){this.refreshStack(),this.stack.push(t),this.redo(),this.undo(),this.redo(),this.stack.length>=xe/4}function w(){this.sindex<this.stack.length-1?this.dequeue(this.sindex,this.stack.length-1):this.stack.splice(this.sindex+1,this.stack.length),this.updateGlobalBoundings()}function B(t,e){var i=this;t+=1;for(var r=e-(t-1),s=(this.batches,r);s>0;--s){var n=i.batches.splice(t+s-1,1)[0];n.buffer.texture instanceof WebGLTexture&&(n.tiles=[],n.buffer.view=null,n.buffer.data=null,n.buffer.context=null,i.renderer.destroyTexture(n.buffer.texture),n.buffer.texture=null,n.buffer=null),n=null,i.refreshBatches(),i.stack.splice(t+s-1,1)}}function m(t,e){t.batch.tiles.map(function(t){t.cindex;e?t.cindex-=t.cindex>0?1:0:t.cindex+=t.cindex<t.colors.length-1?1:0})}function R(){return this.stack[this.sindex]}function A(){if(this.sindex>=0){var t=this.currentStackOperation();this.fire(t,!1),this.sindex--}}function E(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,!0)}}function S(){this.modes.selectAll=!0}function O(t,e){this.mx=t,this.my=e}function k(t,e){var i=this.getRelativeOffset(t,e);this.eraseTileAt(i.x,i.y)}function _(t,e){var i=this.getStackRelativeTileAt(t,e);if(this.pushTileBatchOperation(),null!==i){i.colors.shift();this.createBatchTileAt(i.x,i.y,[0,0,0,0])}this.finalizeBatchOperation()}function I(t,e){if(this.modes.draw){var i=this.getRelativeOffset(t,e);this.createBatchTileAt(i.x,i.y,this._fillStyle)}}function C(t,e,i){this.pushTileBatchOperation(),this.createBatchTileAt(0|t,0|e,i),this.finalizeBatchOperation()}function L(t,e){var i=this.camera.getRelativeOffset(t,e),r=this.getTileOffsetAt(i.x,i.y);return r}function D(t,e){var i=this.getRelativeOffset(t,e),r=this.createTileAt(i.x,i.y);return r}function U(t,e){var i=new ye;if(this.offsetExceedsIntegerLimit(t,e))throw new Error("Tile position exceeds 32-bit integer limit!");return i.x=0|t,i.y=0|e,i}function M(t,e){var i=this.getRelativeOffset(t,e),r=this.getTileAt(i.x,i.y);return r}function G(t,e){for(var i=this.batches,r=0;r<i.length;++r)for(var s=i.length-1-r,n=i[s].tiles,h=0;h<n.length;++h){var a=n[h];if(a.x===t&&a.y===e)return a}return null}function z(t,e){var i=this.getRelativeOffset(t,e),r=this.getStackRelativeTileAt(i.x,i.y);return r}function P(t,e){for(var i=this.sindex,r=this.batches,s=0;s<r.length;++s){var n=r.length-1-s,h=r[n].tiles;if(!(i-n<0))for(var a=0;a<h.length;++a){var o=h[a];if(o.x===t&&o.y===e)return o}}return null}function F(t,e){var i=re/2,r=v(t-i,re),s=v(e-i,re);return{x:r/re,y:s/re}}function N(t){for(var e=this.batches,i=0;i<e.length;++i)for(var r=e[i].tiles,s=0;s<r.length;++s){var n=r[s];if(n.id===t)return n}return null}function j(){var t=256,e=Math.random()*t|0,i=Math.random()*t|0,r=Math.random()*t|0;return[e,i,r,1]}function X(t,e){for(var i=this.batches,r=0;r<i.length;++r){var s=i.length-1-r,n=i[s],h=n.getTileColorAt(t,e);if(null!==h)return h}return null}function W(t,e){for(var i=this.sindex,r=this.batches,s=0;s<r.length;++s){var n=r.length-1-s,h=r[n];if(!(i-n<0)){var a=h.getTileColorAt(t,e);if(null!==a)return a}}return null}function H(t,e){var i=this.getRelativeOffset(t,e);return this.getStackRelativeTileColorAt(i.x,i.y)}function V(t,e,i){var r=t.canvas;this.x=e,this.y=i,this.width=r.width,this.height=r.height,this.isBuffered=!0,this.isRawBuffer=!0,this.isBackground=!1,this.buffer=new Re(t)}function Y(t,e,i){var r=new ye;r.x=t,r.y=e,r.colors[0]=i,this.tiles.push(r)}function q(t,e){var i=t-this.x,r=e-this.y;if(i<0||i>=this.width||r<0||r>=this.height)return null;var s=this.buffer.data,h=4*(r*this.width+i),a=s[h+0],o=s[h+1],c=s[h+2],l=s[h+3],u=[a,o,c,n(l)];return l<=0?null:u}function J(){if(this.tiles.length>=ge.MIN_L)return!0;var t=this.getBoundings();return t.w-1>=ge.MIN_W||t.h-1>=ge.MIN_H}function K(t,e){if(this.isBackground)return!0;var i=x(this.x,this.y,this.width,this.height,t,e,0,0);return i}function Q(){if(!this.isRawBuffer){if(this.isBackground)return void(this.x=this.y=this.width=this.height=1/0);var t=this.getBoundings();this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}}function Z(){if(this.isRawBuffer)return{x:this.x,y:this.y,w:this.width,h:this.height};for(var t=[],e=[],i=this.tiles,r=0;r<i.length;++r){var s=i[r];t.push(s.x),e.push(s.y)}t.sort(f),e.sort(f);var n=t.length-1,h=0|t[0],a=0|e[0],o=(t[n]-t[0]|0)+1,c=(e[n]-e[0]|0)+1;return{x:h,y:a,w:o,h:c}}function $(){var t=new Se;this.batches.push(t)}function tt(){for(var t=this.batches,e=0;e<t.length;++e){var i=t[e];i.index=e}}function et(){var t=this.batches.length-1,i=this.batches[t];if(i.exceedsBoundings()&&!i.isRawBuffer)i.renderBuffer();else{if(i.isEmpty()&&!i.isBackground)return this.batches.splice(t,1),void this.refreshBatches();if(i.isBackground){var r=this.batches[this.batches.length-2];if(r&&r.isBackground&&l(i.bgcolor,r.bgcolor))return}}null!==i.buffer&&(i.buffer.texture=this.instance.renderer.bufferTexture(String(e()),i.buffer.view,!1)),this.enqueue({batch:i}),this.refreshBatches(),this.refreshStack()}function it(){var t=this.batches.length-1;return this.batches[t]}function rt(){if(this.batches.length){var t=this.getLatestTileBatchOperation();if(!t.tiles.length){var e=this.batches.length-1;this.batches.splice(e,1)}}}function st(t,e){this.modes.draw=!0;var i=this.getRelativeOffset(t,e);this.pushTileBatchOperation(),this.createBatchTileAt(i.x,i.y,this._fillStyle)}function nt(t,e){this.modes.draw=!1,this.finalizeBatchOperation(),this.clearLatestTileBatch()}function ht(t,e,i){var r=this.getTileAt(t,e),s=this.getLatestTileBatchOperation();if(null===r||!r.colorMatchesWithTile(i)&&r.colors[r.cindex][3]!==ae){var n=this.createTileAt(t,e);n.colors.unshift(i),s.addTile(n)}}function at(t){for(var e=t.id,i=this.batches,r=(t.x,t.y,0);r<i.length;++r)for(var s=i[r],n=s.tiles,h=0;h<n.length;++h){var a=n[h];if(a.id===e)return s}return null}function ot(t,e){for(var i=this.batches,r=this.sindex,s=0;s<i.length;++s){var n=i.length-1-s;if(!(r<n)){var h=i[n];if(h.isBackground)return h;if(h.pointInsideBoundings(t,e))return h}}return null}function ct(t,e){for(var i=this.batches,r=0;r<i.length;++r){var s=i[r];s.isBackground&&s.renderBackground(t,e,s.bgcolor)}}function lt(t,e){var i=this.boundings,r=x(i.x,i.y,i.w,i.h,t,e,0,0);return r}function ut(t){for(var e=[],i=[],r=[],s=[],n=this.sindex,h=0;h<t.length;++h){var a=t[h];if(!(n<h)){var o=a.getBoundings();e.push(o.x),i.push(o.y),r.push(o.x+o.w),s.push(o.y+o.h)}}e.sort(f),i.sort(f),r.sort(f),s.sort(f);var c=0|e[0],l=0|i[0],u=r.length-1,d=-c+r[u],g=-l+s[u];return{x:c,y:l,w:d,h:g}}function ft(){var t=this.getAbsoluteBoundings(this.batches),e=this.boundings;t.x===e.x&&t.y===e.y&&t.w===e.w&&t.h===e.h||(e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h)}function dt(t){var e=this.camera,i=e.s,r=e.width,s=e.height,n=e.x,h=e.y,a=t.width*re*i,o=t.height*re*i,c=t.x*re*i+n,l=t.y*re*i+h;return!!t.isBackground||c+a>=0&&c<=r&&l+o>=0&&l<=s}function gt(t,e,i,r){r||(r=[255,255,255,1]),this.insertArc(t,e,i,r)}function vt(t,e,i,r){var s=this,n=i,h=0,a=1-n;for(this.pushTileBatchOperation();n>=h;)s.createBatchTileAt(n+t,h+e,r),s.createBatchTileAt(h+t,n+e,r),s.createBatchTileAt(-n+t,h+e,r),s.createBatchTileAt(-h+t,n+e,r),s.createBatchTileAt(-n+t,-h+e,r),s.createBatchTileAt(-h+t,-n+e,r),s.createBatchTileAt(n+t,-h+e,r),s.createBatchTileAt(h+t,-n+e,r),h++,a<=0&&(a+=2*h+1),a>0&&(n--,a+=2*(h-n)+1);this.finalizeBatchOperation()}function xt(t,e,i,r,s){s||(s=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|r,s,!0)}function pt(t,e,i,r,s){s||(s=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|r,s,!1)}function Tt(t,e,i,r,s,n){var h=this,a=Math.abs(i),o=Math.abs(r);this.pushTileBatchOperation();for(var c=i<0?-1:1,l=r<0?-1:1,u=t,f=e,d=0;d<o;++d)for(var g=0;g<a;++g)(n||0===g||g>=a-1||0===d||d>=o-1)&&h.createBatchTileAt(u+g*c,f+d*l,s);this.finalizeBatchOperation()}function yt(t,e,i){var r=t.canvas,s=r.width,n=r.height,h=(t.getImageData(0,0,s,n).data,this.getRelativeOffset(e,i));this.pushTileBatchOperation();var a=this.getLatestTileBatchOperation();a.createRawBufferAt(t,h.x,h.y),this.finalizeBatchOperation()}function bt(t,e){var i=this,r=t.tiles;this.pushTileBatchOperation();for(var s=0;s<r.length;++s){var n=r[s],h=n.colors[n.cindex],a=e<0?0:255,o=e<0?-e:e,c=Math.round((a-h[0])*o)+h[0],l=Math.round((a-h[1])*o)+h[1],u=Math.round((a-h[2])*o)+h[2],f=h[3];i.createBatchTileAt(n.x,n.y,[c,l,u,f])}this.finalizeBatchOperation()}function wt(t){for(var e=t.tiles,i=0;i<e.length;++i)if(i>0&&i+1<e.length){var r=e[i],s=e[i+1],n=e[i-1];n.x!==r.x&&n.y!==r.y||s.x!==r.x&&s.y!==r.y||n.x===s.x||n.y===s.y||(e.splice(i,1),++i)}}function Bt(){var t=this.ctx;t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT)}function mt(){var t=this.ctx,e=this.psprite;t.uniform2f(t.getUniformLocation(e,"uScale"),this.width,this.height)}function Rt(t,e,i,r,s){e|=0,i|=0,r|=0,s|=0;var n=this.ctx,h=this.psprite;n.uniform2f(n.getUniformLocation(h,"uObjScale"),r,s);for(var a=this.vertices.position,o=0;o<6;++o)a[2*o+0]=e+r/2,a[2*o+1]=i+s/2;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,t),this.setAttribute(h,this.buffers.position,"aObjCen",2,a),n.drawArrays(n.TRIANGLES,0,6)}function At(t,e,i,r,s){t|=0,e|=0,i|=0,r|=0;var n=this.ctx,h=this.psprite;n.uniform2f(n.getUniformLocation(h,"uObjScale"),i,r),n.uniform1i(n.getUniformLocation(h,"isRect"),1);for(var a=this.vertices.position,o=0;o<6;++o)a[2*o+0]=t+i/2,a[2*o+1]=e+r/2;n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.empty),n.uniform4f(n.getUniformLocation(h,"vColor"),s[0],s[1],s[2],s[3]),this.setAttribute(h,this.buffers.position,"aObjCen",2,a),n.drawArrays(n.TRIANGLES,0,6),n.uniform1i(n.getUniformLocation(h,"isRect"),0)}function Et(){var t=this.ctx,e=this.camera.width,i=this.camera.height,r=(this.psprite,this.view);this.width=e,this.height=i,r.width=e,r.height=i,t.viewport(0,0,e,i),t.enable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.STENCIL_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)}function St(t){this.view=t;var e=d(this.view);e.disable(e.DEPTH_TEST),e.disable(e.CULL_FACE),e.disable(e.BLEND),this.ctx=e,this.buildShaders(),this.empty=this.createEmptyTexture(),this.resize()}function Ot(){this.psprite=this.createSpriteProgram()}function kt(){var t=this.ctx,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),e}function _t(){var t=this.ctx,e=pe,i=t.createProgram(),r=t.createShader(t.VERTEX_SHADER),s=t.createShader(t.FRAGMENT_SHADER);this.compileShader(r,De),this.compileShader(s,Ue),t.attachShader(i,r),t.attachShader(i,s),t.linkProgram(i);var n=this.buffers,h=this.vertices,a=h.idx=new Float32Array(6*e);h.position=new Float32Array(12*e),n.idx=t.createBuffer(),n.position=t.createBuffer();for(var o=0;o<e;o++)a[6*o+0]=0,a[6*o+1]=1,a[6*o+2]=2,a[6*o+3]=1,a[6*o+4]=2,a[6*o+5]=3;return this.setAttribute(i,n.idx,"aIdx",1,a),i}function It(t,e){var i=this.ctx;i.shaderSource(t,e),i.compileShader(t)}function Ct(t,e,i,r,s){var n=this.ctx,h=n.getAttribLocation(t,i);n.enableVertexAttribArray(h),n.bindBuffer(n.ARRAY_BUFFER,e),s.length>0&&n.bufferData(n.ARRAY_BUFFER,s,n.DYNAMIC_DRAW),n.vertexAttribPointer(h,r,n.FLOAT,!1,0,0)}function Lt(t,e,i){var r=this.ctx,s=r.createTexture();return r.bindTexture(r.TEXTURE_2D,s),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),i===!0?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST)),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),void 0===this.textures[t]&&(this.textures[t]=s),r.bindTexture(r.TEXTURE_2D,null),this.textures[t]}function Dt(t){var e=this.ctx,i=this.textures;for(var r in i){var s=i[r];if(s===t){e.deleteTexture(s),delete i[r],s=null;break}}}function Ut(t,e){var i=this.ctx;i.bindTexture(i.TEXTURE_2D,t),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,e)}function Mt(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,this.camera.resize(t,e),this.bg=this.createBackgroundBuffer(),this.grid=this.createGridBuffer(),this.editor.resizeBackgroundBatches(t,e),this.renderer.resize(),this.redraw()}function Gt(){this.showGrid()&&this.redrawGridBuffer(),this.clear(),this.render()}function zt(){this.renderer.clear()}function Pt(){this.renderer.ctx.useProgram(this.renderer.psprite),this.renderer.updateViewport(),this.renderBackground(),this.showGrid()&&this.renderGrid(),this.renderBatches(),this.drawHoveredTile()}function Ft(){var t=this.camera.width,e=this.camera.height;this.renderer.drawImage(this.bg,0,0,t,e)}function Nt(){var t=this.camera.width,e=this.camera.height;this.renderer.drawImage(this.gridTexture,0,0,t,e)}function jt(){for(var t=this,e=this.editor.sindex,i=this.editor.stack,r=0;r<i.length;++r){var s=i[r].batch;e-r<0||t.editor.isBatchInsideView(s)&&(s.isBackground?t.drawBackgroundBatch(s):s.isBuffered?t.drawBatchedBuffer(s):t.drawBatchedTiles(s))}if(this.editor.modes.draw){var n=this.editor.batches.length;n>0&&this.drawBatchedTiles(this.editor.batches[n-1])}}function Xt(t){var e=(this.ctx,t.bgbuffer),i=0|e.width,r=0|e.height;this.renderer.drawImage(t.buffer.texture,0,0,i,r)}function Wt(t){for(var e=this,i=0|this.camera.x,r=0|this.camera.y,s=v(this.camera.s,he),n=re*s|0,h=re*s|0,a=t.tiles,o=0;o<a.length;++o){var c=a[o],l=i+c.x*re*s|0,u=r+c.y*re*s|0,f=c.colors[c.cindex];f[0],f[1],f[2],f[3];e.renderer.drawRectangle(l,u,n,h,c.getColorAsRgbaBytes())}}function Ht(t){var e=0|this.camera.x,i=0|this.camera.y,r=v(this.camera.s,he),s=t.x*re,n=t.y*re,h=e+s*r|0,a=i+n*r|0,o=t.width*re*r|0,c=t.height*re*r|0;this.renderer.drawImage(t.buffer.texture,h,a,o,c)}function Vt(){var t=0|this.camera.x,e=0|this.camera.y,i=v(this.camera.s,he),r=re*i|0,s=re*i|0,n=this.editor.mx,h=this.editor.my,a=this.editor.getRelativeOffset(n,h),o=a.x*re,c=a.y*re,l=t+fe/2+o*i|0,u=e+fe/2+c*i|0;n!==-0&&h!==-0&&this.renderer.drawRectangle(l,u,r,s,[255,255,255,.2])}function Yt(){var t=this.editor.mx,e=this.editor.my,i=this.editor.getRelativeOffset(t,e),r=i.x,s=i.y,n=this.editor.getStackRelativeTileColorAt(r,s);if(this.ctx.fillStyle="#ffffff",this.ctx.fillText("x:"+r+", y:"+s,16,32),null!==n){var h=n[0],a=n[1],o=n[2],c=n[3];this.ctx.fillStyle="rgba("+h+","+a+","+o+","+c+")",this.ctx.fillRect(6,42,8,8),this.ctx.fillStyle="#ffffff",this.ctx.fillText(h+","+a+","+o+","+c,20,48)}this.renderFPS()}function qt(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillText(1e3/e|0,16,16)}function Jt(){var t=this.camera.width,e=this.camera.height,i=r(t,e);return null!==this.grid&&(this.grid=null,this.renderer.destroyTexture(this.gridTexture)),this.grid=i,this.gridTexture=this.renderer.bufferTexture("grid",i.canvas,!0),this.redrawGridBuffer(),i}function Kt(){var t=this.grid,e=this.gridTexture,i=(v(this.camera.s,he),re*this.camera.s|0),r=0|this.camera.x,s=0|this.camera.y,n=this.camera.width,h=this.camera.height;t.clearRect(0,0,n,h),t.lineWidth=fe,t.strokeStyle="rgba(51,51,51,0.5)",t.beginPath();for(var a=r%i|0;a<n;a+=i)t.moveTo(a,0),t.lineTo(a,h);for(var o=s%i|0;o<h;o+=i)t.moveTo(0,o),t.lineTo(n,o);t.stroke(),t.stroke(),t.closePath(),this.renderer.updateTexture(e,t.canvas)}function Qt(){this.bg instanceof WebGLTexture&&this.renderer.destroyTexture(this.bg);var t=8,e=this.width,i=this.height,r=document.createElement("canvas"),s=r.getContext("2d");r.width=e,r.height=i,s.fillStyle="#1f1f1f",s.fillRect(0,0,e,i),s.fillStyle="#212121";for(var n=0;n<i;n+=2*t)for(var h=0;h<e;h+=2*t)s.fillRect(h,n,t,t),s.fillRect(h,n,t,t);for(var a=t;a<i;a+=2*t)for(var o=t;o<e;o+=2*t)s.fillRect(o,a,t,t);var c=this.renderer.bufferTexture("background",r,!1);return c}var Zt=0,$t=[0,0,0,0],te=480,ee=320,ie=!1,re=8,se=.1,ne=32,he=.125,ae=2,oe=[0,0,0,0],ce=Math.pow(2,31)-1,le=.00392,ue=.5,fe=.25,de=15,ge={MIN_W:1,MIN_H:1,MIN_L:1},ve=i("draw"),xe=255,pe=1e3,Te="undefined"!=typeof WebGLRenderingContext,ye=function(){this.x=0,this.y=0,this.id=e(),this.cindex=0,this.colors=[oe]};ye.prototype.colorMatchesWithTile=function(t){return l(this.colors[this.cindex],t)},ye.prototype.getColorAsRgbaBytes=function(){return h(this.colors[this.cindex])},ye.prototype.getColorAsRgbaString=function(){var t=this.colors[this.cindex],e=t[0],i=t[1],r=t[2],s=t[3];return"rgba("+e+","+i+","+r+","+s+")"};var be=function(t){this.x=0,this.y=0,this.s=se+1,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};be.prototype.scale=function(t){var e=t*(de/100)*g(this.s),i=this.s;this.s+e<=se?this.s=se:this.s+e>=ne?this.s=ne:this.s+=e,this.s=v(this.s,he),this.s>=ne-1+.25&&(this.s=ne-1+.25),this.x-=this.lx*(g(this.s)-g(i)),this.y-=this.ly*(g(this.s)-g(i)),this.instance.redraw()},be.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},be.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.redraw()},be.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,r=(e-this.y)/this.s;return{x:i,y:r}},be.prototype.resize=function(t,e){this.width=t,this.height=e};var we=Object.freeze({fillBucket:p,binaryFloodFill:T,fillBackground:y}),Be=Object.freeze({enqueue:b,refreshStack:w,dequeue:B,fire:m,currentStackOperation:R,undo:A,redo:E}),me=Object.freeze({selectAll:S,hover:O,eraseTileAtMouseOffset:k,eraseTileAt:_,drawTileAtMouseOffset:I,drawTileAt:C,getRelativeOffset:L,createTileAtMouseOffset:D,createTileAt:U,getTileByMouseOffset:M,getTileAt:G,getStackRelativeTileByMouseOffset:z,getStackRelativeTileAt:P,getTileOffsetAt:F,getTileById:N,getRandomRgbaColors:j,getTileColorAt:X,getStackRelativeTileColorAt:W,getStackRelativeTileColorByMouseOffset:H}),Re=function(t){var e=t.canvas;this.view=e,this.texture=null,this.context=t,this.data=t.getImageData(0,0,e.width,e.height).data},Ae=Object.freeze({createRawBufferAt:V,createRawTileAt:Y,getRawColorAt:q}),Ee=Object.freeze({exceedsBoundings:J,pointInsideBoundings:K,updateBoundings:Q,getBoundings:Z}),Se=function(){this.id=e(),this.x=0,this.y=0,this.width=0,this.height=0,this.index=0,this.tiles=[],this.buffer=null,this.bgcolor=null,this.bgbuffer=null,this.isBuffered=!1,this.isRawBuffer=!1,this.isBackground=!1};Se.prototype.isEmpty=function(){return!this.isBuffered&&!this.isRawBuffer&&!this.isBackground&&this.tiles.length<=0},Se.prototype.addTile=function(t){this.tiles.push(t),this.updateBoundings()},Se.prototype.getTileAt=function(t,e){for(var i=this.tiles,r=i.length,s=0;s<r;++s){var n=i[s];if(n.x===t&&n.y===e)return n}return null},Se.prototype.getTileColorAt=function(t,e){if(this.isEmpty())return null;if(this.isRawBuffer){var i=this.getRawColorAt(t,e);if(null!==i)return i}if(this.isBackground)return this.bgcolor;var r=this.getTileAt(t,e);return null!==r?r.colors[r.cindex]:null},Se.prototype.renderBuffer=function(){for(var t=r(this.width,this.height),e=0|this.x,i=0|this.y,s=this.tiles,n=0;n<s.length;++n){var h=s[n],a=(h.colors[h.cindex],h.x-e|0),o=h.y-i|0;t.fillStyle=h.getColorAsRgbaString(),t.fillRect(a,o,1,1)}this.buffer=new Re(t),this.isBuffered=!0,this.updateBoundings()},Se.prototype.renderBackground=function(t,e,i){var s=r(t,e),n=i[0],h=i[1],a=i[2],o=i[3];s.fillStyle="rgba("+n+","+h+","+a+","+o+")",s.fillRect(0,0,t,e),this.bgcolor=i,this.bgbuffer=s.canvas},t(Se,Ae),t(Se,Ee);var Oe=Object.freeze({pushTileBatchOperation:$,refreshBatches:tt,finalizeBatchOperation:et,getLatestTileBatchOperation:it,clearLatestTileBatch:rt,startBatchedDrawing:st,stopBatchedDrawing:nt,createBatchTileAt:ht,getBatchByTile:at,getStackRelativeBatchByPoint:ot,resizeBackgroundBatches:ct,pointInsideAbsoluteBoundings:lt,getAbsoluteBoundings:ut,updateGlobalBoundings:ft,isBatchInsideView:dt}),ke=Object.freeze({strokeArc:gt,insertArc:vt,fillRect:xt,strokeRect:pt,insertRectangleAt:Tt,drawImage:yt}),_e=Object.freeze({applyColorLightness:bt,applyPixelSmoothing:wt}),Ie=function(t){this.instance=t,this.renderer=t.renderer,this.modes={draw:!1,selectAll:!1},this.batches=[],this.mx=-0,this.my=-0,this._fillStyle=[255,255,255,1],this.camera=t.camera,this.sindex=-1,this.stack=[],this.boundings={x:0,y:0,w:0,h:0}},Ce={fillStyle:{}};Ce.fillStyle.get=function(){return this._fillStyle},Ce.fillStyle.set=function(t){if("string"==typeof t)this._fillStyle=o(t);else{if(!(t instanceof Array&&4===t.length))throw new Error("Unsupported or invalid color");this._fillStyle=t}},Ie.prototype.offsetExceedsIntegerLimit=function(t,e){return Math.abs(t)>ce||Math.abs(e)>ce},Object.defineProperties(Ie.prototype,Ce),t(Ie,we),t(Ie,Be),t(Ie,me),t(Ie,Oe),t(Ie,ke),t(Ie,_e);var Le=Object.freeze({clear:Bt,updateViewport:mt,drawImage:Rt,drawRectangle:At,resize:Et}),De="\n  precision lowp float;\n  uniform vec2 uScale;\n  uniform vec2 uObjScale;\n  attribute vec2 aObjCen;\n  attribute float aIdx;\n  varying vec2 uv;\n  void main(void) {\n    if (aIdx == 0.0) {\n      uv = vec2(0.0,0.0);\n    } else if (aIdx == 1.0) {\n      uv = vec2(1.0,0.0);\n    } else if (aIdx == 2.0) {\n      uv = vec2(0.0,1.0);\n    } else {\n      uv = vec2(1.0,1.0);\n    }\n    gl_Position = vec4(\n      -1.0 + 2.0 * (aObjCen.x + uObjScale.x * (-0.5 + uv.x)) / uScale.x,\n      1.0 - 2.0 * (aObjCen.y + uObjScale.y * (-0.5 + uv.y)) / uScale.y,\n      0.0, 1.0\n    );\n  }\n",Ue="\n  precision lowp float;\n  uniform sampler2D uSampler;\n  varying vec2 uv;\n  uniform int isRect;\n  uniform vec4 vColor;\n  void main(void) {\n    if (isRect == 0) {\n      gl_FragColor = texture2D(uSampler, uv);\n    } else {\n      gl_FragColor = vColor + texture2D(uSampler, uv);\n    }\n    if (gl_FragColor.a < 0.1) discard;\n  }\n",Me=Object.freeze({setup:St,buildShaders:Ot,createEmptyTexture:kt,createSpriteProgram:_t,compileShader:It,setAttribute:Ct}),Ge=Object.freeze({bufferTexture:Lt,destroyTexture:Dt,updateTexture:Ut}),ze=function(t){this.view=null,this.ctx=null,this.empty=null,this.colors=[0,0,0,1],this.width=0,this.height=0,this.vertices={idx:null,position:null,rotation:null},this.buffers={idxs:null,position:null,rotation:null},this.textures={},this.instance=t,this.camera=this.instance.camera};t(ze,Le),t(ze,Me),t(ze,Ge);var Pe=Object.freeze({resize:Mt,redraw:Gt,clear:zt,render:Pt,renderBackground:Ft,renderGrid:Nt,renderBatches:jt,drawBackgroundBatch:Xt,drawBatchedTiles:Wt,drawBatchedBuffer:Ht,drawHoveredTile:Vt,renderStats:Yt,renderFPS:qt}),Fe=Object.freeze({createGridBuffer:Jt,redrawGridBuffer:Kt,createBackgroundBuffer:Qt}),Ne=function(t){void 0===t&&(t={}),this.bg=null,this.view=null,this.grid=null,this.tile=null,this.gridTexture=null,this.events={},this.camera=new be(this),this.renderer=new ze(this),this.editor=new Ie(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},this.hideGrid=!1,this.createView(),this.applySettings(t),this.init()};if(Ne.prototype.applySettings=function(t){var e=!ie,i=te,r=ee;t.width>=0&&(i=0|t.width),t.height>=0&&(r=0|t.height),void 0!==t.grid&&(e=!!t.grid),this.hideGrid=!e,this.resize(i,r)},Ne.prototype.init=function(){this.camera.scale(0),this.renderLoop()},Ne.prototype.createView=function(){var t=document.createElement("canvas");t.width=this.width,t.height=this.height,this.view=t,this.renderer.setup(t)},Ne.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events[ve].fn(),t.frames++,t.renderLoop()})},Ne.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},Ne.prototype.showGrid=function(){return!this.hideGrid&&this.camera.s>se+ue},Ne.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");var r=i(t);this.events[r]&&(this.events[r]=null),this.events[r]={fn:e},this.processEmitter(r,e)},Ne.prototype.processEmitter=function(t,e){0===this.frames&&t===ve&&(this.states.paused=!1)},Ne.prototype.exportAsDataUrl=function(){for(var t=this.editor,e=t.batches,i=t.boundings,s=i.x,n=i.y,h=i.w,o=i.h,c=r(h,o),l=c.canvas,u=t.sindex,f=0;f<e.length;++f){var d=e[f];if(!(u<f))if(d.isBackground)c.fillStyle=a(d.bgcolor),c.fillRect(0,0,l.width,l.height);else if(d.isBuffered)c.drawImage(d.buffer.view,d.x-s|0,d.y-n|0,0|d.width,0|d.height);else if(d.tiles.length)for(var g=d.tiles,v=0;v<g.length;++v){var x=g[v],p=x.x-s|0,T=x.y-n|0,y=a(x.colors[x.cindex]);c.fillStyle=y,c.fillRect(p,T,1,1)}else;}return l.toDataURL()},Ne.prototype.getBatches=function(t){void 0===t&&(t=!1);for(var e=[],i=this.editor.sindex,r=this.editor.batches,s=0;s<r.length;++s)t&&i-s<0||e.push(r[s]);return e},Ne.prototype.getColorAtMouseOffset=function(t,e){var i=this.editor.getRelativeOffset(t,e),r=i.x,s=i.y,n=this.editor.getStackRelativeTileColorAt(r,s);return n?c(n):null},t(Ne,Pe),t(Ne,Fe),"undefined"==typeof window)throw new Error("Please run Poxi inside a browser");window.Poxi=Ne});
