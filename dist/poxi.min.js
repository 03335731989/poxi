!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function e(){return St++}function i(t){for(var e=0,i=t.length,r=0;r<i;++r){var s=t.charCodeAt(r);e=(e<<5)-e+s,e|=0}return e}function r(t,e){var i=document.createElement("canvas");i.width=t,i.height=e;var r=i.getContext("2d");return s(r,!1),r}function s(t,e){t.imageSmoothingEnabled=e,t.oImageSmoothingEnabled=e,t.msImageSmoothingEnabled=e,t.webkitImageSmoothingEnabled=e}function n(t,e){var i=new Image;i.addEventListener("load",function(){e(i)}),i.addEventListener("error",function(){throw new Error("Failed to load image ressource "+t)}),i.src=t}function h(t){return Math.round(t*jt*10)/10}function a(t){var e=t[0],i=t[1],r=t[2],s=t[3];return"rgba("+e+","+i+","+r+","+s+")"}function o(t){var e=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16);return[e,i,r,1]}function l(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function c(t){return l(t,Ct)}function f(t,e){return t-e}function u(t){return t>=0?t+1:t<0?t+1:t+1}function d(t,e){var i=1/e;return Math.round(t*i)/i}function g(t,e,i,r,s,n,h,a){var o=Math.max(t,s),l=Math.min(t+i,s+h),c=Math.max(e,n),f=Math.min(e+r,n+a);return l>=o&&f>=c}function v(t,e,i){if(i=i||[255,255,255,1],i[3]>1)throw new Error("Invalid alpha color!");this.refreshStack();var s=!1,n=this.sindex,h=this.getTileColorAt(t,e);this.pushTileBatchOperation();var a=this.getLatestTileBatchOperation();if(s=null!==h?this.fillBucketColorBased(t,e,h,i):this.fillBucketEmptyTileBased(t,e,i),a.updateBoundings(),a.tiles.length){for(var o=a.x,l=a.y,c=r(a.width,a.height),f=0;f<a.tiles.length;++f){var u=a.tiles[f],d=u.x-a.x,g=u.y-a.y;c.fillStyle=u.getColorAsRgbaString(),c.fillRect(d,g,1,1)}a.createRawBufferAt(c,o,l),a.tiles=[]}this.finalizeBatchOperation(),s&&(n<this.sindex&&(this.undo(),this.refreshStack()),this.fillBackground(i))}function p(t){c(t);this.pushTileBatchOperation();var e=this.getLatestTileBatchOperation();e.isBackground=!0,e.renderBackground(this.camera.width,this.camera.height,t),e.updateBoundings(),this.finalizeBatchOperation()}function y(t,e,i,r){var s=this;if(l(r,i))return!1;for(var n=[{x:t,y:e}],h=this.getLatestTileBatchOperation();n.length>0;){var a=n.pop(),o=a.x,c=a.y;if(!s.pointInsideAbsoluteBoundings(o,c))return!0;h.getTileColorAt(o,c)||h.createRawTileAt(o,c,r);var f=h.getTileAt(o+1,c)||s.getStackRelativeTileColorAt(o+1,c),u=h.getTileAt(o-1,c)||s.getStackRelativeTileColorAt(o-1,c),d=h.getTileAt(o,c+1)||s.getStackRelativeTileColorAt(o,c+1),g=h.getTileAt(o,c-1)||s.getStackRelativeTileColorAt(o,c-1);null!==f&&l(f,i)&&n.push({x:o+1,y:c}),null!==u&&l(u,i)&&n.push({x:o-1,y:c}),null!==d&&l(d,i)&&n.push({x:o,y:c+1}),null!==g&&l(g,i)&&n.push({x:o,y:c-1})}return!1}function x(t,e,i){for(var r=this,s=[{x:t,y:e}],n=this.getLatestTileBatchOperation();s.length>0;){var h=s.pop(),a=h.x,o=h.y;if(!r.pointInsideAbsoluteBoundings(a,o))return!0;n.getTileColorAt(a,o)||n.createRawTileAt(a,o,i),console.log(n.getTileAt(a+1,o),r.getStackRelativeTileColorAt(a+1,o));var l=n.getTileAt(a+1,o)||r.getStackRelativeTileColorAt(a+1,o),c=n.getTileAt(a-1,o)||r.getStackRelativeTileColorAt(a-1,o),f=n.getTileAt(a,o+1)||r.getStackRelativeTileColorAt(a,o+1),u=n.getTileAt(a,o-1)||r.getStackRelativeTileColorAt(a,o-1);null===l&&s.push({x:a+1,y:o}),null===c&&s.push({x:a-1,y:o}),null===f&&s.push({x:a,y:o+1}),null===u&&s.push({x:a,y:o-1})}return!1}function B(t){this.refreshStack(),this.stack.push(t),this.redo(),this.undo(),this.redo(),this.stack.length>=Vt/4}function w(){this.sindex<this.stack.length-1?this.dequeue(this.sindex,this.stack.length-1):this.stack.splice(this.sindex+1,this.stack.length)}function T(t,e){var i=this;t+=1;for(var r=e-(t-1),s=(this.batches,r);s>0;--s)i.batches.splice(t+s-1,1),i.refreshBatches(),i.stack.splice(t+s-1,1)}function m(t,e){t.batch.tiles.map(function(t){t.cindex;e?t.cindex-=t.cindex>0?1:0:t.cindex+=t.cindex<t.colors.length-1?1:0})}function b(){return this.stack[this.sindex]}function A(){if(this.sindex>=0){var t=this.currentStackOperation();this.fire(t,!1),this.sindex--}}function k(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,!0)}}function R(){this.modes.selectAll=!0}function O(t,e){this.mx=t,this.my=e}function S(t,e){var i=this.getRelativeOffset(t,e);this.eraseTileAt(i.x,i.y)}function C(t,e){var i=this.getStackRelativeTileAt(t,e);if(this.pushTileBatchOperation(),null!==i){i.colors.shift();this.createBatchTileAt(i.x,i.y,[0,0,0,0])}this.finalizeBatchOperation()}function I(t,e){if(this.modes.draw){var i=this.getRelativeOffset(t,e);this.createBatchTileAt(i.x,i.y,this._fillStyle)}}function M(t,e,i){this.pushTileBatchOperation(),this.createBatchTileAt(0|t,0|e,i),this.finalizeBatchOperation()}function E(t,e){var i=this.camera.getRelativeOffset(t,e),r=this.getTileOffsetAt(i.x,i.y);return r}function z(t,e){var i=this.getRelativeOffset(t,e),r=this.createTileAt(i.x,i.y);return r}function L(t,e){var i=new Jt;if(this.offsetExceedsIntegerLimit(t,e))throw new Error("Tile position exceeds 32-bit integer limit!");return i.x=0|t,i.y=0|e,i}function _(t,e){var i=this.getRelativeOffset(t,e),r=this.getTileAt(i.x,i.y);return r}function P(t,e){for(var i=this.batches,r=0;r<i.length;++r)for(var s=i.length-1-r,n=i[s].tiles,h=0;h<n.length;++h){var a=n[h];if(a.x===t&&a.y===e)return a}return null}function j(t,e){var i=this.getRelativeOffset(t,e),r=this.getStackRelativeTileAt(i.x,i.y);return r}function D(t,e){for(var i=this.sindex,r=this.batches,s=0;s<r.length;++s){var n=r.length-1-s,h=r[n].tiles;if(!(i-n<0))for(var a=0;a<h.length;++a){var o=h[a];if(o.x===t&&o.y===e)return o}}return null}function F(t,e){var i=It/2,r=d(t-i,It),s=d(e-i,It);return{x:r/It,y:s/It}}function N(t){for(var e=this.batches,i=0;i<e.length;++i)for(var r=e[i].tiles,s=0;s<r.length;++s){var n=r[s];if(n.id===t)return n}return null}function q(){var t=256,e=Math.random()*t|0,i=Math.random()*t|0,r=Math.random()*t|0;return[e,i,r,1]}function H(t,e){for(var i=this.batches,r=0;r<i.length;++r){var s=i.length-1-r,n=i[s],h=n.getTileColorAt(t,e);if(null!==h)return h}return null}function V(t,e){for(var i=this.sindex,r=this.batches,s=0;s<r.length;++s){var n=r.length-1-s,h=r[n];if(!(i-n<0)){var a=h.getTileColorAt(t,e);if(null!==a)return a}}return null}function W(t,e){var i=this.getRelativeOffset(t,e);return this.getStackRelativeTileColorAt(i.x,i.y)}function G(t){var e=this.camera.s,i=this.camera.width,r=this.camera.height,s=It*e,n=It*e,h=t.x*It*e+this.camera.x,a=t.y*It*e+this.camera.y;return h+s>=0&&h-s<=i&&a+n>=0&&a-n<=r}function U(){var t=new Xt;this.batches.push(t)}function J(){for(var t=this.batches,e=0;e<t.length;++e){var i=t[e];i.index=e}}function K(){var t=this.batches.length-1,e=this.batches[t];if(e.exceedsBounds()&&!e.isRawBuffer)e.renderBuffer();else{if(e.isEmpty()&&!e.isBackground)return this.batches.splice(t,1),void this.refreshBatches();if(e.isBackground){var i=this.batches[this.batches.length-2];if(i&&i.isBackground&&l(e.bgcolor,i.bgcolor))return}}this.enqueue({batch:e}),this.updateGlobalBoundings(),this.refreshBatches()}function Q(){var t=this.batches.length-1;return this.batches[t]}function X(){if(this.batches.length){var t=this.getLatestTileBatchOperation();if(!t.tiles.length){var e=this.batches.length-1;this.batches.splice(e,1)}}}function Y(t,e){this.modes.draw=!0;var i=this.getRelativeOffset(t,e);this.pushTileBatchOperation(),this.createBatchTileAt(i.x,i.y,this._fillStyle)}function Z(t,e){this.modes.draw=!1,this.finalizeBatchOperation(),this.clearLatestTileBatch()}function $(t,e,i){var r=this.getTileAt(t,e),s=this.getLatestTileBatchOperation();if(null===r||!r.colorMatchesWithTile(i)&&r.colors[r.cindex][3]!==Lt){var n=this.createTileAt(t,e);n.colors.unshift(i),s.addTile(n)}}function tt(t){for(var e=t.id,i=this.batches,r=(t.x,t.y,0);r<i.length;++r)for(var s=i[r],n=s.tiles,h=0;h<n.length;++h){var a=n[h];if(a.id===e)return s}return null}function et(t,e){for(var i=this.batches,r=this.sindex,s=0;s<i.length;++s){var n=i.length-1-s;if(!(r<n)){var h=i[n];if(h.isBackground)return h;if(h.pointInsideBoundings(t,e))return h}}return null}function it(t,e){for(var i=this.batches,r=0;r<i.length;++r){var s=i[r];s.isBackground&&s.renderBackground(t,e,s.bgcolor)}}function rt(t,e){var i=this.boundings,r=g(i.x,i.y,i.w,i.h,t,e,0,0);return r}function st(t){for(var e=[],i=[],r=[],s=[],n=this.sindex,h=0;h<t.length;++h){var a=t[h];if(!(n<h)){var o=a.getBoundings();e.push(o.x),i.push(o.y),r.push(o.x+o.w),s.push(o.y+o.h)}}e.sort(f),i.sort(f),r.sort(f),s.sort(f);var l=0|e[0],c=0|i[0],u=r.length-1,d=-l+r[u],g=-c+s[u];return{x:l,y:c,w:d,h:g}}function nt(){var t=this.getAbsoluteBoundings(this.batches),e=this.boundings;t.x===e.x&&t.y===e.y&&t.w===e.w&&t.h===e.h||(e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h)}function ht(t,e,i,r){r||(r=[255,255,255,1]),this.insertArc(t,e,i,r)}function at(t,e,i,r){var s=this,n=i,h=0,a=1-n;for(this.pushTileBatchOperation();n>=h;)s.createBatchTileAt(n+t,h+e,r),s.createBatchTileAt(h+t,n+e,r),s.createBatchTileAt(-n+t,h+e,r),s.createBatchTileAt(-h+t,n+e,r),s.createBatchTileAt(-n+t,-h+e,r),s.createBatchTileAt(-h+t,-n+e,r),s.createBatchTileAt(n+t,-h+e,r),s.createBatchTileAt(h+t,-n+e,r),h++,a<=0&&(a+=2*h+1),a>0&&(n--,a+=2*(h-n)+1);this.finalizeBatchOperation()}function ot(t,e,i,r,s){s||(s=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|r,s,!0)}function lt(t,e,i,r,s){s||(s=[255,255,255,1]),this.insertRectangleAt(0|t,0|e,0|i,0|r,s,!1)}function ct(t,e,i,r,s,n){var h=this,a=Math.abs(i),o=Math.abs(r);this.pushTileBatchOperation();for(var l=i<0?-1:1,c=r<0?-1:1,f=t,u=e,d=0;d<o;++d)for(var g=0;g<a;++g)(n||0===g||g>=a-1||0===d||d>=o-1)&&h.createBatchTileAt(f+g*l,u+d*c,s);this.finalizeBatchOperation()}function ft(t,e,i){var r=t.canvas,s=r.width,n=r.height,h=(t.getImageData(0,0,s,n).data,this.getRelativeOffset(e,i));this.pushTileBatchOperation();var a=this.getLatestTileBatchOperation();a.createRawBufferAt(t,h.x,h.y),this.finalizeBatchOperation()}function ut(t,e){var i=this,r=t.tiles;this.pushTileBatchOperation();for(var s=0;s<r.length;++s){var n=r[s],h=n.colors[n.cindex],a=e<0?0:255,o=e<0?-e:e,l=Math.round((a-h[0])*o)+h[0],c=Math.round((a-h[1])*o)+h[1],f=Math.round((a-h[2])*o)+h[2],u=h[3];i.createBatchTileAt(n.x,n.y,[l,c,f,u])}this.finalizeBatchOperation()}function dt(t){for(var e=t.tiles,i=0;i<e.length;++i)if(i>0&&i+1<e.length){var r=e[i],s=e[i+1],n=e[i-1];n.x!==r.x&&n.y!==r.y||s.x!==r.x&&s.y!==r.y||n.x===s.x||n.y===s.y||(e.splice(i,1),++i)}}function gt(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,s(this.ctx,!1),this.camera.resize(t,e),this.generateBackground(),this.editor.resizeBackgroundBatches(t,e),this.clear(),this.render()}function vt(){this.ctx.clearRect(0,0,this.width,this.height)}function pt(){this.renderBackground(),this.renderBatches(),this.camera.s>Mt+Dt&&this.renderGrid(),this.renderStats()}function yt(){var t=this.camera.width,e=this.camera.height;this.ctx.drawImage(this.bg,0,0,t,e,0,0,t,e)}function xt(){var t=this.ctx,e=It*this.camera.s|0,i=this.camera.x,r=this.camera.y,s=this.camera.width,n=this.camera.height;t.lineWidth=Ft,t.strokeStyle="rgba(51,51,51,0.75)",t.beginPath();for(var h=i%e|0;h<s;h+=e)t.moveTo(h,0),t.lineTo(h,n);for(var a=r%e|0;a<n;a+=e)t.moveTo(0,a),t.lineTo(s,a);t.stroke(),t.closePath()}function Bt(){for(var t=this,e=this.editor.sindex,i=this.editor.stack,r=0;r<i.length;++r){var s=i[r].batch;e-r<0||(s.isBackground?t.drawBackgroundBatch(s):s.isBuffered?t.drawBatchedBuffer(s):t.drawBatchedTiles(s))}if(this.editor.modes.draw){var n=this.editor.batches.length;n>0&&this.drawBatchedTiles(this.editor.batches[n-1])}this.drawHoveredTile(),this.drawActiveCursor()}function wt(){if(this.cursor){var t=this.cursors[this.cursor];if(t){var e=this.ctx,i=this.editor.modes.draw;i===!0&&(e.globalCompositeOperation="exclusion");var r=this.editor.mx,s=this.editor.my,n=1+t.width/6|0,h=1+t.height/6|0,a=r+n/2|0,o=s+h/2|0;e.drawImage(t,0,0,t.width,t.height,a,o,n,h),i===!0&&(e.globalCompositeOperation="source-over")}}}function Tt(t){var e=this.ctx,i=t.bgbuffer,r=0|i.width,s=0|i.height;e.drawImage(i,0,0,r,s,0,0,r,s)}function mt(t){for(var e=this,i=this.camera.x,r=this.camera.y,s=this.camera.s,n=It*s|0,h=It*s|0,a=this.ctx,o=t.tiles,l=0;l<o.length;++l){var c=o[l];if(e.editor.isTileInsideView(c)){var f=i+c.x*It*s|0,u=r+c.y*It*s|0,d=c.colors[c.cindex],g=d[0],v=d[1],p=d[2],y=d[3];a.fillStyle="rgba("+g+","+v+","+p+","+y+")",a.fillRect(f,u,n,h)}}}function bt(t){var e=0|this.camera.x,i=0|this.camera.y,r=this.camera.s,s=t.x*It,n=t.y*It,h=e+s*r|0,a=i+n*r|0,o=t.width*It|0,l=t.height*It|0;this.ctx.drawImage(t.buffer.view,0,0,o,l,h,a,o*It*r|0,l*It*r|0)}function At(){var t=this.ctx,e=this.camera.x,i=this.camera.y,r=this.camera.s,s=It*r|0,n=It*r|0,h=this.editor.mx,a=this.editor.my,o=this.editor.getRelativeOffset(h,a),l=o.x*It,c=o.y*It,f=e+Ft/2+l*r|0,u=i+Ft/2+c*r|0;t.fillStyle="rgba(255, 255, 255, 0.2)",t.fillRect(f,u,s,n)}function kt(){var t=this.editor.mx,e=this.editor.my,i=this.editor.getRelativeOffset(t,e),r=i.x,s=i.y,n=this.editor.getStackRelativeTileColorAt(r,s);if(this.ctx.fillStyle="#ffffff",this.ctx.fillText("x:"+r+", y:"+s,16,32),null!==n){var h=n[0],a=n[1],o=n[2],l=n[3];this.ctx.fillStyle="rgba("+h+","+a+","+o+","+l+")",this.ctx.fillRect(6,42,8,8),this.ctx.fillStyle="#ffffff",this.ctx.fillText(h+","+a+","+o+","+l,20,48)}this.renderFPS()}function Rt(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillText(1e3/e|0,16,16)}function Ot(){var t=8,e=this.width,i=this.height,s=(r(e,i),document.createElement("canvas")),n=s.getContext("2d");s.width=e,s.height=i,this.bg=s,n.fillStyle="#1f1f1f",n.fillRect(0,0,e,i),n.fillStyle="#212121";for(var h=0;h<i;h+=2*t)for(var a=0;a<e;a+=2*t)n.fillRect(a,h,t,t),n.fillRect(a,h,t,t);for(var o=t;o<i;o+=2*t)for(var l=t;l<e;l+=2*t)n.fillRect(l,o,t,t)}var St=0,Ct=[0,0,0,0],It=8,Mt=.25,Et=32,zt=.125,Lt=2,_t=[0,0,0,0],Pt=Math.pow(2,31)-1,jt=.00392,Dt=0,Ft=.25,Nt=15,qt={MIN_W:8,MIN_H:8,MIN_L:32},Ht=i("draw"),Vt=255,Wt=function(t){this.x=0,this.y=0,this.s=Mt+6,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};Wt.prototype.scale=function(t){var e=t*(Nt/100)*u(this.s),i=this.s;this.s+e<=Mt?this.s=Mt:this.s+e>=Et?this.s=Et:this.s+=e,this.s=d(this.s,zt),this.x-=this.lx*(u(this.s)-u(i)),this.y-=this.ly*(u(this.s)-u(i)),this.instance.redraw()},Wt.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},Wt.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.redraw()},Wt.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,r=(e-this.y)/this.s;return{x:i,y:r}},Wt.prototype.resize=function(t,e){this.width=t,this.height=e};var Gt=Object.freeze({fillBucket:v,fillBackground:p,fillBucketColorBased:y,fillBucketEmptyTileBased:x}),Ut=Object.freeze({enqueue:B,refreshStack:w,dequeue:T,fire:m,currentStackOperation:b,undo:A,redo:k}),Jt=function(){this.x=0,this.y=0,this.id=e(),this.cindex=0,this.colors=[_t]};Jt.prototype.colorMatchesWithTile=function(t){return l(this.colors[this.cindex],t)},Jt.prototype.getColorAsRgbaString=function(t){var e=this.colors[t||0],i=e[0],r=e[1],s=e[2],n=e[3];return"rgba("+i+","+r+","+s+","+n+")"};var Kt=Object.freeze({selectAll:R,hover:O,eraseTileAtMouseOffset:S,eraseTileAt:C,drawTileAtMouseOffset:I,drawTileAt:M,getRelativeOffset:E,createTileAtMouseOffset:z,createTileAt:L,getTileByMouseOffset:_,getTileAt:P,getStackRelativeTileByMouseOffset:j,getStackRelativeTileAt:D,getTileOffsetAt:F,getTileById:N,getRandomRgbaColors:q,getTileColorAt:H,getStackRelativeTileColorAt:V,getStackRelativeTileColorByMouseOffset:W,isTileInsideView:G}),Qt=function(t,e,i){this.x=e,this.y=i;var r=t.canvas;this.view=r,this.width=r.width,this.height=r.height,this.context=t,this.tiles=[]},Xt=function(){this.id=e(),this.x=0,this.y=0,this.width=0,this.height=0,this.index=0,this.tiles=[],this.buffer=null,this.bgcolor=null,this.bgbuffer=null,this.isBuffered=!1,this.isRawBuffer=!1,this.isBackground=!1};Xt.prototype.renderBackground=function(t,e,i){var s=r(t,e),n=i[0],h=i[1],a=i[2],o=i[3];s.fillStyle="rgba("+n+","+h+","+a+","+o+")",s.fillRect(0,0,t,e),this.bgcolor=i,this.bgbuffer=s.canvas},Xt.prototype.pointInsideBoundings=function(t,e){if(this.isBackground)return!0;var i=g(this.x,this.y,this.width,this.height,t,e,0,0);return i},Xt.prototype.updateBoundings=function(){if(!this.isRawBuffer){if(this.isBackground)return void(this.x=this.y=this.width=this.height=1/0);var t=this.getBoundings();this.x=t.x,this.y=t.y,this.width=t.w,this.height=t.h}},Xt.prototype.getBoundings=function(){if(this.isRawBuffer)return{x:this.x,y:this.y,w:this.width,h:this.height};for(var t=[],e=[],i=this.tiles,r=0;r<i.length;++r){var s=i[r];t.push(s.x),e.push(s.y)}t.sort(f),e.sort(f);var n=t.length-1,h=0|t[0],a=0|e[0],o=(t[n]-t[0]|0)+1,l=(e[n]-e[0]|0)+1;return{x:h,y:a,w:o,h:l}},Xt.prototype.createRawBufferAt=function(t,e,i){var r=t.canvas;this.x=e,this.y=i,this.width=r.width,this.height=r.height,this.isBuffered=!0,this.isRawBuffer=!0,this.isBackground=!1,this.buffer=new Qt(t,e,i)},Xt.prototype.createRawTileAt=function(t,e,i){var r=new Jt;r.x=t,r.y=e,r.colors.unshift(i),this.tiles.push(r)},Xt.prototype.renderBuffer=function(){for(var t=r(this.width,this.height),e=0|this.x,i=0|this.y,s=this.tiles,n=0;n<s.length;++n){var h=s[n],a=(h.colors[h.cindex],h.x-e|0),o=h.y-i|0;t.fillStyle=h.getColorAsRgbaString(),t.fillRect(a,o,1,1)}this.buffer=new Qt(t,e,i),this.isBuffered=!0,this.updateBoundings()},Xt.prototype.exceedsBounds=function(){if(this.tiles.length>=qt.MIN_L)return!0;var t=this.getBoundings();return t.w-1>=qt.MIN_W||t.h-1>=qt.MIN_H},Xt.prototype.isEmpty=function(){return!this.isBuffered&&!this.isRawBuffer&&!this.isBackground&&this.tiles.length<=0},Xt.prototype.getTileColorAt=function(t,e){if(this.isEmpty())return null;if(this.isRawBuffer){var i=t-this.x,r=e-this.y;if(i<0||r<0)return null;if(i>this.width||this.yy>this.height)return null;var s=this.buffer.context.getImageData(i,r,1,1).data,n=h(s[3]),a=[s[0],s[1],s[2],n];return c(a)||n<=0?null:[s[0],s[1],s[2],n]}if(this.isBackground)return this.bgcolor;var o=this.getTileAt(t,e);return null!==o?o.colors[o.cindex]:null},Xt.prototype.getTileAt=function(t,e){for(var i=this.tiles,r=i.length,s=0;s<r;++s){var n=i[s];if(n.x===t&&n.y===e)return n}return null},Xt.prototype.addTile=function(t){this.tiles.push(t),this.updateBoundings()};var Yt=Object.freeze({pushTileBatchOperation:U,refreshBatches:J,finalizeBatchOperation:K,getLatestTileBatchOperation:Q,clearLatestTileBatch:X,startBatchedDrawing:Y,stopBatchedDrawing:Z,createBatchTileAt:$,getBatchByTile:tt,getStackRelativeBatchByPoint:et,resizeBackgroundBatches:it,pointInsideAbsoluteBoundings:rt,getAbsoluteBoundings:st,updateGlobalBoundings:nt}),Zt=Object.freeze({strokeArc:ht,insertArc:at,fillRect:ot,strokeRect:lt,insertRectangleAt:ct,drawImage:ft}),$t=Object.freeze({applyColorLightness:ut,applyPixelSmoothing:dt}),te=function(t){this.instance=t,this.modes={draw:!1,selectAll:!1},this.batches=[],this.mx=-1,this.my=-1,this._fillStyle=[255,255,255,1],this.camera=t.camera,this.sindex=-1,this.stack=[],this.boundings={x:0,y:0,w:0,h:0}},ee={fillStyle:{}};ee.fillStyle.get=function(){return this._fillStyle},ee.fillStyle.set=function(t){if("string"==typeof t)this._fillStyle=o(t);else{if(!(t instanceof Array&&4===t.length))throw new Error("Unsupported or invalid color");this._fillStyle=t}},te.prototype.offsetExceedsIntegerLimit=function(t,e){return Math.abs(t)>Pt||Math.abs(e)>Pt},Object.defineProperties(te.prototype,ee),t(te,Gt),t(te,Ut),t(te,Kt),t(te,Yt),t(te,Zt),t(te,$t);var ie=Object.freeze({resize:gt,clear:vt,render:pt,renderBackground:yt,renderGrid:xt,renderBatches:Bt,drawActiveCursor:wt,drawBackgroundBatch:Tt,drawBatchedTiles:mt,drawBatchedBuffer:bt,drawHoveredTile:At,renderStats:kt,renderFPS:Rt,generateBackground:Ot}),re=function(t){this.bg=null,this.ctx=null,this.view=null,this.events={},this.camera=new Wt(this),this.editor=new te(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},this.cursor=null,this.cursors={},this.createView(),t.width>=0&&t.height>=0?this.resize(t.width,t.height):this.resize(view.width,view.height),this.init()},se={activeCursor:{}};if(re.prototype.init=function(){this.renderLoop()},re.prototype.createView=function(){var t=r(this.width,this.height);this.ctx=t,this.view=t.canvas},re.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events[Ht].fn(),t.frames++,t.renderLoop()})},re.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},re.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");var r=i(t);this.events[r]&&(this.events[r]=null),this.events[r]={fn:e},this.processEmitter(r,e)},re.prototype.processEmitter=function(t,e){0===this.frames&&t===Ht&&(this.states.paused=!1)},re.prototype.redraw=function(){this.clear(),this.render()},re.prototype.exportAsDataUrl=function(){for(var t=this.editor,e=t.batches,i=t.boundings,s=i.x,n=i.y,h=i.w,o=i.h,l=r(h,o),c=l.canvas,f=t.sindex,u=0;u<e.length;++u){var d=e[u];if(!(f<u))if(d.isBackground)l.fillStyle=a(d.bgcolor),l.fillRect(0,0,c.width,c.height);else if(d.isBuffered)l.drawImage(d.buffer.view,d.x-s|0,d.y-n|0,0|d.width,0|d.height);else if(d.tiles.length)for(var g=d.tiles,v=0;v<g.length;++v){var p=g[v],y=p.x-s|0,x=p.y-n|0,B=a(p.colors[p.cindex]);l.fillStyle=B,l.fillRect(y,x,1,1)}else;}return c.toDataURL()},re.prototype.addCursor=function(t,e){var i=this;this.cursor;this.cursors[t]=null,n(e,function(e){i.cursors[t]=e})},se.activeCursor.set=function(t){void 0!==this.cursors[t]?this.cursor=t:this.cursor=null},Object.defineProperties(re.prototype,se),t(re,ie),"undefined"==typeof window)throw new Error("Please run Poxi inside a browser");window.Poxi=re});
