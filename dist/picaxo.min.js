!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(this,function(){"use strict";function t(t){return t>=0?t+1:t<0?t+1:t+1}function e(t,e){var i=1/e;return Math.round(t*i)/i}function i(t,e){var i=null;for(i in e)e[i]instanceof Function&&(t.prototype[i]=e[i])}function s(){return H++}function h(t){this.sindex<this.stack.length-1&&this.dequeue(this.sindex,this.stack.length-1),this.stack.splice(this.sindex+1,this.stack.length),this.stack.push(t),this.redo(),this.undo(),this.redo()}function r(t,e){var i=this;t+=1;for(var s=e-(t-1),h=this.batches.tiles,r=0;r<s;++r){var n=t+r,o=i.stack[n];h.splice(o.index,1);for(var a=0;a<this.stack.length;++a)i.stack[a].index-=1}}function n(t,e){t.batch.map(function(t){var i=t.cindex,s=t.colors.length-1;e===!0?t.cindex-=i>0?1:0:t.cindex+=i<s?1:0})}function o(){return this.stack[this.sindex]}function a(){if(this.sindex>=0){var t=this.currentStackOperation();this.fire(t,!1),this.sindex--}}function c(){if(this.sindex<this.stack.length-1){this.sindex++;var t=this.currentStackOperation();this.fire(t,!0)}}function l(){this.modes.selectAll=!0}function f(t,e,i){if(this.modes.drag=i,this.modes.draw=!!i,i&&this.modes.draw)this.colorTest=this.setRandomColor(),this.pushTileBatchOperation(),this.pushTileBatch(t,e),this.clearLatestTileBatch();else{var s=this.batches.tiles.length-1;this.enqueue({batch:this.batches.tiles[s],index:s})}}function d(){var t=this.getLatestTileBatchOperation();if(t.length<=0){var e=this.batches.tiles.length-1;this.batches.tiles.splice(e,1)}}function u(){var t=255*Math.random()+1|0,e=255*Math.random()+1|0,i=255*Math.random()+1|0;return[t,e,i,1]}function v(t,i){var s=this.camera.getRelativeOffset(t,i),h=L/2;return s.x=e(s.x-h,L),s.y=e(s.y-h,L),s}function p(t,e){var i=this.getRelativeOffset(t,e),s=new q;return s.x=i.x,s.y=i.y,s}function x(){var t=this.batches.tiles.length-1,e=this.batches.tiles;return e[t]}function y(){var t=[];this.batches.tiles.push(t)}function m(t,e){var i=this.getRelativeOffset(t,e),s=this.findTileAt(i.x,i.y);return s}function g(t,e){for(var i=null,s=this.batches.tiles,h=0;h<s.length;++h)for(var r=s[h],n=0;n<r.length;++n){var o=r[n];o.x===t&&o.y===e&&(i=o)}return i}function w(t,e){var i=this.getTileFromMouseOffset(t,e),s=[this.colorTest[0],this.colorTest[1],this.colorTest[2],this.colorTest[3]],h=this.getLatestTileBatchOperation();if(null!==i){var r=i.colors[i.cindex],n=this.colorArraysMatch(s,r);n||2===r[3]||(i.colors.unshift(s),h.push(i))}else{var o=this.createTileByMouseOffset(t,e);o.colors.unshift(s),h.push(o)}}function T(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function O(){for(var t=this,e=0;e<this.hovered.length;++e)t.hovered[e].isHovered=!1,t.hovered.splice(e,1)}function b(t){var e=this.camera.s,i=this.camera.width,s=this.camera.height,h=L*e,r=L*e,n=t.x*e+this.camera.x,o=t.y*e+this.camera.y;return n+h>=0&&n<=i&&o+r>=0&&o<=s}function k(t,e){t>=0&&(this.width=t),e>=0&&(this.height=e),this.view.width=t,this.view.height=e,this.camera.resize(t,e),this.clear(),this.render()}function M(){this.ctx.clearRect(0,0,this.width,this.height)}function B(){this.renderGrid(),this.renderTiles(),this.renderFPS()}function A(){var t=Date.now(),e=t-this.last;this.last=t,this.ctx.fillStyle="#fff",this.ctx.fillText(1e3/e|0,16,16)}function E(){for(var t=this,e=this.ctx,i=this.camera.x,s=this.camera.y,h=this.camera.s,r=L*h|0,n=L*h|0,o=this.editor.modes.selectAll,a=this.editor.batches.tiles,c=0;c<a.length;++c)for(var l=a[c],f=0;f<l.length;++f){var d=l[f],u=i+d.x*h|0,v=s+d.y*h|0,p=d.colors[d.cindex],x=p[0],y=p[1],m=p[2],g=p[3];o?g=.1:d.isHovered&&(g/=1.5),t.editor.isTileInsideView(d)&&(e.fillStyle="rgba("+x+","+y+","+m+","+g+")",e.fillRect(u,v,r,n))}}function R(){var t=this.ctx,e=L*this.camera.s|0,i=this.camera.x,s=this.camera.y,h=this.camera.width,r=this.camera.height;t.lineWidth=.25,t.strokeStyle="#333333",t.beginPath();for(var n=i%e|0;n<h;n+=e)t.moveTo(n,0),t.lineTo(n,r);for(var o=s%e|0;o<r;o+=e)t.moveTo(0,o),t.lineTo(h,o);t.stroke(),t.closePath()}var L=8,z=1,F=35,S=[0,0,0,0],V=function(t){this.x=0,this.y=0,this.s=z+6,this.dx=0,this.dy=0,this.lx=0,this.ly=0,this.width=0,this.height=0,this.instance=t};V.prototype.scale=function(e){e=42*e/(Math.hypot(this.width,this.height)/2)*t(this.s);var i=this.s;this.s+=e,this.s+e<=z&&(this.s=z),this.s+e>=F&&(this.s=F),this.x-=this.lx*(t(this.s)-t(i)),this.y-=this.ly*(t(this.s)-t(i))},V.prototype.click=function(t,e){var i=this.getRelativeOffset(t,e);this.dx=t,this.dy=e,this.lx=i.x,this.ly=i.y},V.prototype.drag=function(t,e){this.x+=t-this.dx,this.y+=e-this.dy,this.dx=t,this.dy=e,this.instance.clear(),this.instance.render()},V.prototype.getRelativeOffset=function(t,e){var i=(t-this.x)/this.s,s=(e-this.y)/this.s;return{x:i,y:s}},V.prototype.resize=function(t,e){this.width=t,this.height=e};var H=0,P=Object.freeze({enqueue:h,dequeue:r,fire:n,currentStackOperation:o,undo:a,redo:c}),q=function(){this.x=0,this.y=0,this.id=s(),this.cindex=0,this.colors=[S],this.isHovered=!1},j=Object.freeze({selectAll:l,select:f,clearLatestTileBatch:d,setRandomColor:u,getRelativeOffset:v,createTileByMouseOffset:p,getLatestTileBatchOperation:x,pushTileBatchOperation:y,getTileFromMouseOffset:m,findTileAt:g,pushTileBatch:w,colorArraysMatch:T,unHoverAllTiles:O,isTileInsideView:b}),C=function(t){this.modes={draw:!1,drag:!1,selectAll:!1},this.batches={tiles:[]},this.hovered=[],this.colorTest=null,this.camera=t.camera,this.sindex=-1,this.stack=[]};C.prototype.drag=function(t,e){this.modes.drag&&this.modes.draw&&this.pushTileBatch(t,e)},C.prototype.hover=function(t,e){this.unHoverAllTiles();var i=this.getTileFromMouseOffset(t,e);null!==i&&(this.hovered.push(i),i.isHovered=!0)},i(C,P),i(C,j);var I=Object.freeze({resize:k,clear:M,render:B,renderFPS:A,renderTiles:E,renderGrid:R}),G=function(t){return this.ctx=null,this.view=null,this.events={},this.camera=new V(this),this.editor=new C(this),this.last=0,this.width=0,this.height=0,this.frames=0,this.states={paused:!0},t&&this.isViewElement(t)?void this.applyView(t):(this.applyView(t.view),t.width>=0&&t.height>=0?this.resize(t.width,t.height):this.resize(view.width,view.height),void this.init())};if(G.prototype.init=function(){this.renderLoop()},G.prototype.renderLoop=function(){var t=this;this.states.paused===!0?setTimeout(function(){return t.renderLoop()},16):requestAnimationFrame(function(){t.events.draw.fn(),t.frames++,t.renderLoop()})},G.prototype.applyView=function(t){if(!this.isViewElement(t))throw new Error("Invalid view element provided");this.view=t,this.ctx=t.getContext("2d")},G.prototype.isViewElement=function(t){return t&&t instanceof HTMLCanvasElement},G.prototype.on=function(t,e){if("string"!=typeof t)throw new Error("Expected emitter kind to be string");if(!(e instanceof Function))throw new Error("Received emitter trigger is not a function");this.events[t]&&(this.events[t]=null),this.events[t]={fn:e},this.processEmitter(t,e)},G.prototype.processEmitter=function(t,e){0===this.frames&&"draw"===t&&(this.states.paused=!1)},i(G,I),"undefined"==typeof window)throw new Error("Please run Picaxo inside a browser");window.Picaxo=G});
